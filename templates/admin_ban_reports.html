{% extends "base.html" %}

{% block title %}å°å·ææŠ¥å®¡æ ¸ - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}å°å·ææŠ¥å®¡æ ¸{% endblock %}

{% block content %}
<div class="admin-header-card">
    <div class="admin-header-info">
        <div class="admin-header-title">
            <span class="admin-icon">ğŸš«</span>
            <div>
                <h3>å°å·ææŠ¥å®¡æ ¸</h3>
                <p class="admin-subtitle">å®¡æ ¸ç”¨æˆ·ææŠ¥å¹¶åº”ç”¨åˆ°ç»“ç®—æ‰£å‡</p>
            </div>
        </div>
        <div class="admin-actions">
            <button class="btn-admin-action" onclick="loadBanReports()">
                <span>ğŸ”„</span> åˆ·æ–°
            </button>
        </div>
    </div>
</div>

<div class="admin-section-card audit-card">
    <div class="admin-section-header">
        <h3>ğŸ“‹ ææŠ¥åˆ—è¡¨</h3>
        <div class="filter-group">
            <select id="banPeriodFilter" onchange="loadBanReports()">
                <option value="">å…¨éƒ¨ç»“ç®—æœŸ</option>
            </select>
            <select id="banStatusFilter" onchange="loadBanReports()">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="0">â³ å¾…å®¡æ ¸</option>
                <option value="1">âœ… å·²é€šè¿‡</option>
                <option value="2">âŒ å·²é©³å›</option>
            </select>
            <select id="banAppliedFilter" onchange="loadBanReports()">
                <option value="">åº”ç”¨çŠ¶æ€</option>
                <option value="0">æœªåº”ç”¨</option>
                <option value="1">å·²åº”ç”¨</option>
            </select>
            <button class="btn-filter" onclick="loadBanReports()">ğŸ”„ åˆ·æ–°</button>
        </div>
    </div>
    <div class="admin-section-body">
        <div class="table-wrapper">
            <table class="admin-table">
                <thead>
                    <tr>
                        <th class="col-id">ID</th>
                        <th class="col-period-id">æœŸID</th>
                        <th class="col-user">ç”¨æˆ·ID</th>
                        <th>è¢«å°ç¦</th>
                        <th>çŠ¶æ€</th>
                        <th>æ˜¯å¦å·²åº”ç”¨</th>
                        <th>æˆªå›¾</th>
                        <th>æäº¤æ—¶é—´</th>
                        <th>å®¡æ ¸æ—¶é—´</th>
                        <th>é©³å›åŸå› </th>
                        <th class="col-actions">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="banReportTableBody">
                    <tr><td colspan="11" class="loading-cell">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* å¤ç”¨ç¼´è´¹å®¡æ ¸é¡µæ ·å¼ï¼ˆä¿æŒä¸€è‡´ï¼‰ */
.admin-header-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.25);
}

.admin-header-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.admin-header-title {
    display: flex;
    align-items: center;
    gap: 16px;
}

.admin-icon {
    font-size: 48px;
    background: rgba(255,255,255,0.2);
    width: 72px;
    height: 72px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.admin-header-title h3 {
    margin: 0;
    color: white;
    font-size: 20px;
    font-weight: 600;
}

.admin-subtitle {
    margin: 4px 0 0 0;
    color: rgba(255,255,255,0.8);
    font-size: 14px;
}

.admin-actions {
    display: flex;
    gap: 12px;
}

.btn-admin-action {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 18px;
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 10px;
    color: white;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-admin-action:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-1px);
}

.admin-section-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 20px;
    overflow: hidden;
}

.admin-section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 18px 20px;
    border-bottom: 1px solid #e5e7eb;
    background: #f8fafc;
}

.admin-section-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
}

.filter-group {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.filter-group select {
    padding: 8px 10px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 13px;
    background: white;
}

.btn-filter {
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    font-size: 13px;
}

.admin-section-body {
    padding: 0;
}

.table-wrapper {
    overflow-x: auto;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.admin-table thead th {
    text-align: left;
    padding: 12px 12px;
    color: #374151;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
    white-space: nowrap;
}

.admin-table tbody td {
    padding: 12px 12px;
    border-bottom: 1px solid #f1f5f9;
    color: #111827;
    vertical-align: top;
}

.loading-cell,
.empty-cell {
    text-align: center;
    color: #6b7280;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: white;
    cursor: pointer;
    font-size: 12px;
    margin-right: 6px;
    margin-bottom: 6px;
}

.action-btn.primary {
    border-color: rgba(102, 126, 234, 0.5);
}

.action-btn.danger {
    border-color: rgba(239, 68, 68, 0.5);
}

.status-pill {
    display: inline-flex;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 600;
    border: 1px solid transparent;
}

.status-pill.pending {
    background: rgba(245, 158, 11, 0.12);
    color: #b45309;
    border-color: rgba(245, 158, 11, 0.35);
}

.status-pill.paid {
    background: rgba(16, 185, 129, 0.12);
    color: #047857;
    border-color: rgba(16, 185, 129, 0.35);
}

.status-pill.rejected {
    background: rgba(239, 68, 68, 0.12);
    color: #b91c1c;
    border-color: rgba(239, 68, 68, 0.35);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function statusLabel(status) {
    const s = Number(status);
    if (s === 1) return { cls: 'paid', text: 'å·²é€šè¿‡' };
    if (s === 2) return { cls: 'rejected', text: 'å·²é©³å›' };
    return { cls: 'pending', text: 'å¾…å®¡æ ¸' };
}

function appliedLabel(isApplied) {
    return Number(isApplied) === 1 ? { cls: 'paid', text: 'å·²åº”ç”¨' } : { cls: 'pending', text: 'æœªåº”ç”¨' };
}

function pill(label) {
    return `<span class="status-pill ${label.cls}">${label.text}</span>`;
}

async function loadPeriods() {
    const sel = document.getElementById('banPeriodFilter');
    if (!sel) return;

    try {
        const periods = await apiRequest('/settlement-periods');
        sel.innerHTML = '<option value="">å…¨éƒ¨ç»“ç®—æœŸ</option>' + (periods || []).map(p => {
            const label = `${p.period_id}ï¼ˆ${p.period_start}~${p.period_end}ï¼‰`;
            return `<option value="${p.period_id}">${label}</option>`;
        }).join('');
    } catch (e) {
        console.error('åŠ è½½ç»“ç®—æœŸå¤±è´¥', e);
    }
}

async function loadBanReports() {
    const tbody = document.getElementById('banReportTableBody');
    if (!tbody) return;

    const periodId = document.getElementById('banPeriodFilter')?.value || '';
    const status = document.getElementById('banStatusFilter')?.value || '';
    const applied = document.getElementById('banAppliedFilter')?.value || '';

    const qs = new URLSearchParams();
    if (periodId) qs.set('period_id', periodId);
    if (status !== '') qs.set('status', status);
    if (applied !== '') qs.set('applied', applied);

    tbody.innerHTML = '<tr><td colspan="11" class="loading-cell">åŠ è½½ä¸­...</td></tr>';
    try {
        const rows = await apiRequest(`/settlement-ban-reports?${qs.toString()}`);
        if (!Array.isArray(rows) || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="11" class="empty-cell">æš‚æ— æ•°æ®</td></tr>';
            return;
        }

        tbody.innerHTML = rows.map(r => {
            const st = statusLabel(r.status);
            const ap = appliedLabel(r.is_applied);
            const proof = r.proof_file_path ? `<a href="/${r.proof_file_path}" target="_blank">æŸ¥çœ‹</a>` : '-';
            const submittedAt = r.submitted_at ? new Date(r.submitted_at).toLocaleString('zh-CN') : '-';
            const reviewedAt = r.reviewed_at ? new Date(r.reviewed_at).toLocaleString('zh-CN') : '-';

            let actions = '-';
            if (Number(r.status) === 0) {
                actions = `
                    <button class="action-btn primary" onclick="approveReport(${r.report_id})">âœ… é€šè¿‡</button>
                    <button class="action-btn danger" onclick="rejectReport(${r.report_id})">âŒ é©³å›</button>
                `;
            } else if (Number(r.status) === 1 && Number(r.is_applied) === 0) {
                actions = `<button class="action-btn primary" onclick="applyReport(${r.report_id})">ğŸ§® åº”ç”¨æ‰£å‡</button>`;
            }

            return `
                <tr>
                    <td>${r.report_id}</td>
                    <td>${r.period_id}</td>
                    <td>${r.user_id}</td>
                    <td>${r.banned_coins} coins</td>
                    <td>${pill(st)}</td>
                    <td>${pill(ap)}</td>
                    <td>${proof}</td>
                    <td>${submittedAt}</td>
                    <td>${reviewedAt}</td>
                    <td>${r.reject_reason || '-'}</td>
                    <td>${actions}</td>
                </tr>
            `;
        }).join('');
    } catch (e) {
        console.error('åŠ è½½å°å·ææŠ¥å¤±è´¥', e);
        tbody.innerHTML = `<tr><td colspan="11" class="empty-cell">åŠ è½½å¤±è´¥ï¼š${e.message || 'æœªçŸ¥é”™è¯¯'}</td></tr>`;
    }
}

async function approveReport(reportId) {
    if (!confirm('ç¡®è®¤é€šè¿‡è¯¥å°å·ææŠ¥ï¼Ÿ')) return;
    try {
        await apiRequest(`/settlement-ban-reports/${reportId}/approve`, { method: 'POST' });
        showToast('å·²é€šè¿‡', 'success');
        await loadBanReports();
    } catch (e) {
        showToast(e.message || 'æ“ä½œå¤±è´¥', 'error');
    }
}

async function rejectReport(reportId) {
    const reason = prompt('è¯·è¾“å…¥é©³å›åŸå› ï¼ˆå¿…å¡«ï¼‰ï¼š');
    if (!reason || !reason.trim()) return;
    try {
        await apiRequest(`/settlement-ban-reports/${reportId}/reject`, {
            method: 'POST',
            body: JSON.stringify({ reject_reason: reason.trim() })
        });
        showToast('å·²é©³å›', 'success');
        await loadBanReports();
    } catch (e) {
        showToast(e.message || 'æ“ä½œå¤±è´¥', 'error');
    }
}

async function applyReport(reportId) {
    const input = prompt('âš ï¸ è¯¥æ“ä½œä¼šæ”¹å†™ç»“ç®—æ±‡æ€»ä¸åº”ç¼´æ•°æ®ï¼Œè¯·è¾“å…¥â€œç¡®è®¤â€ç»§ç»­ï¼š');
    if (input !== 'ç¡®è®¤') return;
    try {
        await apiRequest(`/settlement-ban-reports/${reportId}/apply`, { method: 'POST' });
        showToast('å·²åº”ç”¨æ‰£å‡', 'success');
        await loadBanReports();
    } catch (e) {
        showToast(e.message || 'æ“ä½œå¤±è´¥', 'error');
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    await loadPeriods();
    await loadBanReports();
});
</script>
{% endblock %}

