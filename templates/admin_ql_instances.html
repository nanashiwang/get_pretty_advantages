{% extends "base.html" %}

{% block title %}é’é¾™å®ä¾‹ç®¡ç† - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}é’é¾™å®ä¾‹ç®¡ç†{% endblock %}

{% block content %}
<div class="page-actions">
    <button class="btn btn-primary" onclick="openAddModal()">
        <span>â•</span> æ·»åŠ å®ä¾‹
    </button>
</div>

<div class="data-card">
    <div class="table-responsive">
        <table class="data-table" id="instancesTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>åç§°</th>
                    <th>åœ°å€</th>
                    <th>çŠ¶æ€</th>
                    <th>å¤‡æ³¨</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="instancesTableBody">
                <tr><td colspan="7" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- æ·»åŠ /ç¼–è¾‘æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="instanceModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3 id="instanceModalTitle">æ·»åŠ é’é¾™å®ä¾‹</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="instanceForm">
                <input type="hidden" id="instanceId">
                <div class="form-group">
                    <label>å®ä¾‹åç§° <span class="required">*</span></label>
                    <input type="text" id="instanceName" placeholder="å¦‚ï¼šç”Ÿäº§ç¯å¢ƒé’é¾™" required>
                </div>
                <div class="form-group">
                    <label>è®¿é—®åœ°å€ <span class="required">*</span></label>
                    <input type="text" id="instanceUrl" placeholder="http://ip:5700" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Client ID <span class="required">*</span></label>
                        <input type="text" id="instanceClientId" placeholder="é’é¾™åº”ç”¨ client_id" required>
                    </div>
                    <div class="form-group">
                        <label>Client Secret <span class="required">*</span></label>
                        <input type="password" id="instanceClientSecret" placeholder="é’é¾™åº”ç”¨ client_secret" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>çŠ¶æ€</label>
                        <select id="instanceStatus">
                            <option value="1">å¯ç”¨</option>
                            <option value="0">åœç”¨</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <input type="text" id="instanceRemark" placeholder="å¯é€‰å¤‡æ³¨">
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
            <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveInstance()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
let instances = [];

document.addEventListener('DOMContentLoaded', function() {
    loadInstances();
});

async function loadInstances() {
    const tbody = document.getElementById('instancesTableBody');
    try {
        instances = await apiRequest('/ql-instances');
        renderInstances();
    } catch (error) {
        tbody.innerHTML = '<tr><td colspan="7" class="error-cell">åŠ è½½å¤±è´¥: ' + error.message + '</td></tr>';
    }
}

function renderInstances() {
    const tbody = document.getElementById('instancesTableBody');
    if (!instances || instances.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty-cell">æš‚æ— é’é¾™å®ä¾‹</td></tr>';
        return;
    }
    
    tbody.innerHTML = instances.map(inst => `
        <tr>
            <td>${inst.id}</td>
            <td><strong>${inst.name}</strong></td>
            <td><code>${inst.base_url}</code></td>
            <td><span class="status-badge status-${inst.status === 1 ? 'normal' : 'disabled'}">${inst.status === 1 ? 'å¯ç”¨' : 'åœç”¨'}</span></td>
            <td>${inst.remark || '-'}</td>
            <td>${new Date(inst.created_at).toLocaleDateString('zh-CN')}</td>
            <td class="action-cell">
                <button class="btn-icon" onclick="editInstance(${inst.id})" title="ç¼–è¾‘">âœï¸</button>
                <button class="btn-icon" onclick="testInstanceConnection(${inst.id})" title="æµ‹è¯•è¿æ¥">ğŸ”—</button>
                <button class="btn-icon danger" onclick="deleteInstance(${inst.id})" title="åˆ é™¤">ğŸ—‘ï¸</button>
            </td>
        </tr>
    `).join('');
}

function openAddModal() {
    document.getElementById('instanceModalTitle').textContent = 'æ·»åŠ é’é¾™å®ä¾‹';
    document.getElementById('instanceForm').reset();
    document.getElementById('instanceId').value = '';
    document.getElementById('instanceModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('instanceModal').style.display = 'none';
}

async function editInstance(id) {
    const inst = instances.find(i => i.id === id);
    if (!inst) return;
    
    document.getElementById('instanceModalTitle').textContent = 'ç¼–è¾‘é’é¾™å®ä¾‹';
    document.getElementById('instanceId').value = inst.id;
    document.getElementById('instanceName').value = inst.name;
    document.getElementById('instanceUrl').value = inst.base_url;
    document.getElementById('instanceClientId').value = inst.client_id;
    document.getElementById('instanceClientSecret').value = inst.client_secret;
    document.getElementById('instanceStatus').value = inst.status;
    document.getElementById('instanceRemark').value = inst.remark || '';
    document.getElementById('instanceModal').style.display = 'flex';
}

async function saveInstance() {
    const id = document.getElementById('instanceId').value;
    const data = {
        name: document.getElementById('instanceName').value,
        base_url: document.getElementById('instanceUrl').value,
        client_id: document.getElementById('instanceClientId').value,
        client_secret: document.getElementById('instanceClientSecret').value,
        status: parseInt(document.getElementById('instanceStatus').value),
        remark: document.getElementById('instanceRemark').value || null
    };
    
    try {
        if (id) {
            await apiRequest(`/ql-instances/${id}`, { method: 'PUT', body: JSON.stringify(data) });
            showToast('å®ä¾‹æ›´æ–°æˆåŠŸ', 'success');
        } else {
            await apiRequest('/ql-instances', { method: 'POST', body: JSON.stringify(data) });
            showToast('å®ä¾‹æ·»åŠ æˆåŠŸ', 'success');
        }
        closeModal();
        loadInstances();
    } catch (error) {
        showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
    }
}

async function deleteInstance(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé’é¾™å®ä¾‹å—ï¼Ÿ')) return;
    
    try {
        await apiRequest(`/ql-instances/${id}`, { method: 'DELETE' });
        showToast('åˆ é™¤æˆåŠŸ', 'success');
        loadInstances();
    } catch (error) {
        showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
    }
}

async function testConnection() {
    const url = document.getElementById('instanceUrl').value;
    const clientId = document.getElementById('instanceClientId').value;
    const clientSecret = document.getElementById('instanceClientSecret').value;
    
    if (!url || !clientId || !clientSecret) {
        showToast('è¯·å…ˆå¡«å†™å®Œæ•´çš„è¿æ¥ä¿¡æ¯', 'warning');
        return;
    }
    
    try {
        const result = await apiRequest('/ql-instances/test', {
            method: 'POST',
            body: JSON.stringify({ base_url: url, client_id: clientId, client_secret: clientSecret })
        });
        showToast('è¿æ¥æˆåŠŸï¼', 'success');
    } catch (error) {
        showToast('è¿æ¥å¤±è´¥: ' + error.message, 'error');
    }
}

async function testInstanceConnection(id) {
    try {
        await apiRequest(`/ql-instances/${id}/test`, { method: 'POST' });
        showToast('è¿æ¥æˆåŠŸï¼', 'success');
    } catch (error) {
        showToast('è¿æ¥å¤±è´¥: ' + error.message, 'error');
    }
}
</script>
{% endblock %}
