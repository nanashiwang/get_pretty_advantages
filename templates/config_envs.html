{% extends "base.html" %}

{% block title %}é…ç½®ç¯å¢ƒ{% endblock %}
{% block page_title %}é…ç½®ç¯å¢ƒ{% endblock %}

{% block content %}
<!-- é¡µé¢å¤´éƒ¨ -->
<div class="config-header-card">
    <div class="config-header-info">
        <div class="config-header-title">
            <span class="config-icon">âš™ï¸</span>
            <div>
                <h3>é…ç½®ç¯å¢ƒ</h3>
                <p class="config-subtitle">ç®¡ç†åä¸‹è´¦å·åŠä¸‹çº§è´¦å·çš„ç¯å¢ƒå˜é‡</p>
            </div>
        </div>
        <div class="config-actions">
            <button class="btn-config-action" id="refreshAll">
                <span>ğŸ”„</span> åˆ·æ–°åˆ—è¡¨
            </button>
            <button class="btn-config-action btn-primary" id="startCreateEnv">
                <span>â•</span> æ–°å¢å˜é‡
            </button>
        </div>
    </div>
</div>

<!-- ç¯å¢ƒå˜é‡åˆ—è¡¨ï¼ˆæ‰€æœ‰å¯ç®¡ç†ç”¨æˆ·ï¼‰ -->
<div class="config-section-card env-list-card">
    <div class="config-section-header">
        <h3>ğŸ“‹ ç¯å¢ƒå˜é‡åˆ—è¡¨</h3>
        <div class="header-actions">
            <span class="env-count-badge" id="envCountBadge">0 æ¡è®°å½•</span>
        </div>
    </div>
    <div class="list-filters" id="listFilters">
        <div class="filter-group">
            <label>ç­›é€‰ç”¨æˆ·</label>
            <select id="userFilter">
                <option value="">å…¨éƒ¨ç”¨æˆ·</option>
            </select>
        </div>
        <div class="filter-group">
            <label>ç­›é€‰çŠ¶æ€</label>
            <select id="statusFilter">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="valid">å¯ç”¨</option>
                <option value="invalid">ç¦ç”¨</option>
            </select>
        </div>
    </div>
    <div class="config-section-body">
        <div class="table-wrapper">
            <table class="config-table">
                <thead>
                    <tr>
                        <th class="col-id">ID</th>
                        <th class="col-user">æ‰€å±ç”¨æˆ·</th>
                        <th class="col-name">å˜é‡å</th>
                        <th class="col-value">Cookie å€¼</th>
                        <th class="col-ip">IP ä¿¡æ¯</th>
                        <th class="col-status">çŠ¶æ€</th>
                        <th class="col-remark">å¤‡æ³¨</th>
                        <th class="col-actions">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="envTableBody">
                    <tr><td colspan="8" class="loading-cell">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- é…ç½®è¡¨å• -->
<div class="config-section-card config-form-card" id="formCard" style="display: none;">
    <div class="config-section-header">
        <h3>ğŸ“ é…ç½®ç¯å¢ƒå˜é‡</h3>
        <button class="btn-close-form" id="closeFormBtn">âœ•</button>
    </div>
    <div class="config-section-body">
        <form id="envForm" class="config-form-grid">
            <input type="hidden" id="envId" value="">

            <div class="form-field-group">
                <label for="formUserSelect">
                    <span class="label-icon">ğŸ‘¤</span>
                    é€‰æ‹©ç”¨æˆ·
                    <span class="required-mark">*</span>
                </label>
                <select id="formUserSelect" required></select>
                <span class="input-hint">ä¸ºä¸‹çº§è´¦å·é…ç½®ç¯å¢ƒå˜é‡</span>
            </div>

            <div class="form-field-group">
                <label>å˜é‡åï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰</label>
                <div class="auto-name-tag" id="autoEnvName">å°†ç”Ÿæˆ ksck / ksck1 / ksck2 ...</div>
            </div>

            <div class="form-field-group full-width">
                <label for="envValue">
                    <span class="label-icon">ğŸª</span>
                    ksck å€¼
                    <span class="required-mark">*</span>
                </label>
                <textarea id="envValue" rows="3" placeholder="å¡«å†™ Cookie/ksck å€¼" required></textarea>
            </div>

            <div class="form-field-group">
                <label for="envRemark">
                    <span class="label-icon">ğŸ“</span>
                    å¤‡æ³¨
                    <span class="required-mark">*</span>
                </label>
                <input type="text" id="envRemark" placeholder="å¤‡æ³¨ï¼ˆä¼šåŒæ­¥åˆ°é’é¾™å€¼ï¼‰" required>
                <span class="input-hint">å¤‡æ³¨ä½œä¸ºæ”¶ç›Šç»Ÿè®¡çš„å”¯ä¸€æ ‡è¯†ï¼ˆå¿…å¡«ä¸”å”¯ä¸€ï¼‰</span>
            </div>

            <div class="form-field-group">
                <label for="ipSelect">
                    <span class="label-icon">ğŸŒ</span>
                    é€‰æ‹©IP
                    <span class="required-mark">*</span>
                </label>
                <select id="ipSelect" required></select>
                <span class="input-hint">æ¯ä¸ªIPæœ€å¤šåˆ†é…2ä¸ªå˜é‡ï¼Œå®¹é‡æ»¡åä¸ä¼šå‡ºç°</span>
            </div>

            <div class="form-actions-full">
                <button type="submit" class="btn-save">
                    <span>ğŸ’¾</span> ä¿å­˜
                </button>
                <button type="button" class="btn-cancel" id="cancelEdit">
                    <span>âœ–ï¸</span> å–æ¶ˆç¼–è¾‘
                </button>
            </div>
        </form>
    </div>
</div>

<style>
/* é…ç½®é¡µé¢å¤´éƒ¨ */
.config-header-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.25);
}

.config-header-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.config-header-title {
    display: flex;
    align-items: center;
    gap: 16px;
}

.config-icon {
    font-size: 48px;
    background: rgba(255,255,255,0.2);
    width: 72px;
    height: 72px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.config-header-title h3 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
    color: white;
}

.config-subtitle {
    margin: 4px 0 0 0;
    font-size: 14px;
    color: rgba(255,255,255,0.8);
}

.config-actions {
    display: flex;
    gap: 12px;
}

.btn-config-action {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn-config-action:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-1px);
}

.btn-config-action.btn-primary {
    background: white;
    color: #667eea;
    border-color: white;
}

/* åŒºå—å¡ç‰‡ */
.config-section-card {
    background: var(--bg-color);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
    overflow: hidden;
}

.config-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 24px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0,0,0,0.02);
}

.config-section-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.btn-close-form {
    background: transparent;
    border: none;
    font-size: 20px;
    color: var(--text-muted);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    transition: all 0.2s;
}

.btn-close-form:hover {
    background: rgba(0,0,0,0.05);
    color: var(--text-color);
}

.config-section-body {
    padding: 24px;
}

/* ç¯å¢ƒåˆ—è¡¨å¡ç‰‡ */
.env-list-card {
    border-left: 4px solid #10b981;
}

.env-count-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
}

/* ç­›é€‰åŒºåŸŸ */
.list-filters {
    display: flex;
    gap: 16px;
    padding: 16px 24px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0,0,0,0.01);
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.filter-group label {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
}

.filter-group select {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 13px;
    background: var(--bg-color);
    transition: all 0.2s;
    min-width: 120px;
}

.filter-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

/* è¡¨æ ¼å®¹å™¨ */
.table-wrapper {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

/* è¡¨æ ¼æ ·å¼ */
.config-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}

.config-table thead {
    background: linear-gradient(180deg, rgba(102, 126, 234, 0.08) 0%, rgba(102, 126, 234, 0.03) 100%);
}

.config-table thead th {
    text-align: left;
    padding: 12px 14px;
    font-size: 12px;
    font-weight: 600;
    color: #6366f1;
    letter-spacing: 0.3px;
    border-bottom: 2px solid rgba(102, 126, 234, 0.2);
    white-space: nowrap;
}

.config-table thead th.col-id {
    width: 60px;
    text-align: center;
}

.config-table thead th.col-user {
    width: 140px;
}

.config-table thead th.col-name {
    width: 100px;
}

.config-table thead th.col-value {
    min-width: 160px;
}

.config-table thead th.col-ip {
    width: 180px;
}

.config-table thead th.col-status {
    width: 90px;
    text-align: center;
}

.config-table thead th.col-remark {
    width: 120px;
}

.config-table thead th.col-actions {
    width: 200px;
    text-align: center;
}

.config-table tbody td {
    padding: 12px 14px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    color: var(--text-color);
    vertical-align: middle;
}

.config-table tbody tr:last-child td {
    border-bottom: none;
}

.config-table tbody tr {
    transition: all 0.15s ease;
}

.config-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.04);
}

.config-table tbody td.col-id {
    text-align: center;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 11px;
    color: var(--text-muted);
    background: rgba(0, 0, 0, 0.02);
}

.config-table tbody td.col-user {
    font-size: 12px;
}

.user-info-cell {
    display: flex;
    flex-direction: column;
}

.user-name {
    font-weight: 500;
    color: var(--text-color);
}

.user-nickname {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 2px;
}

.user-role-badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    margin-top: 4px;
    width: fit-content;
}

.user-role-badge.role-admin {
    background: rgba(239, 68, 68, 0.1);
    color: #dc2626;
}

.user-role-badge.role-agent {
    background: rgba(59, 130, 246, 0.1);
    color: #2563eb;
}

.user-role-badge.role-normal {
    background: rgba(107, 114, 128, 0.1);
    color: #4b5563;
}

.config-table tbody td.col-name {
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 12px;
    color: #6366f1;
    font-weight: 500;
}

.config-table tbody td.col-value {
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 11px;
    color: #64748b;
}

.config-table tbody td.col-status {
    text-align: center;
}

/* çŠ¶æ€å¾½ç«  */
.status-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
}

.status-badge.valid {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.status-badge.invalid,
.status-badge.disabled {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
}

.status-badge .status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-right: 6px;
}

.status-badge.valid .status-dot {
    background: #10b981;
}

.status-badge.invalid .status-dot,
.status-badge.disabled .status-dot {
    background: #ef4444;
}

/* å€’è®¡æ—¶ */
.countdown {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    background: rgba(245, 158, 11, 0.15);
    color: #d97706;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 500;
    margin-top: 4px;
}

.countdown::before {
    content: 'â±';
    margin-right: 4px;
}

/* æ“ä½œæŒ‰é’® */
.table-actions {
    display: flex;
    gap: 6px;
    justify-content: center;
    flex-wrap: nowrap;
}

.table-actions .btn-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 5px 10px;
    font-size: 12px;
    font-weight: 500;
    background: transparent;
    border: 1px solid rgba(102, 126, 234, 0.2);
    color: #6366f1;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease;
    white-space: nowrap;
    min-width: 50px;
}

.table-actions .btn-link:hover {
    background: #6366f1;
    color: white;
    border-color: #6366f1;
    transform: translateY(-1px);
}

.table-actions .btn-link.danger {
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.2);
}

.table-actions .btn-link.danger:hover {
    background: #ef4444;
    color: white;
    border-color: #ef4444;
}

/* ç©ºçŠ¶æ€ */
.loading-cell,
.empty-cell {
    text-align: center !important;
    padding: 48px 20px !important;
    color: var(--text-muted);
    font-size: 14px;
}

.loading-cell::before {
    content: '';
    display: block;
    width: 48px;
    height: 48px;
    margin: 0 auto 12px;
    border: 3px solid rgba(102, 126, 234, 0.1);
    border-top-color: #6366f1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.text-ellipsis {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    max-width: 200px;
    display: inline-block;
}

/* è¡¨å•æ ·å¼ */
.config-form-card {
    border-left: 4px solid #667eea;
}

.config-form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
}

.form-field-group {
    display: flex;
    flex-direction: column;
}

.form-field-group.full-width {
    grid-column: 1 / -1;
}

.form-field-group label {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.label-icon {
    font-size: 14px;
}

.required-mark {
    color: #ef4444;
    font-weight: 600;
    margin-left: 2px;
}

.auto-name-tag {
    padding: 10px 16px;
    background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
    border-radius: 10px;
    font-size: 13px;
    color: #4338ca;
    font-weight: 500;
}

.form-field-group textarea,
.form-field-group input,
.form-field-group select {
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-size: 14px;
    background: var(--bg-color);
    transition: all 0.2s;
    resize: vertical;
}

.form-field-group textarea:focus,
.form-field-group input:focus,
.form-field-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.input-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
}

.form-actions-full {
    grid-column: 1 / -1;
    display: flex;
    gap: 12px;
    padding-top: 8px;
}

.btn-save {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 12px 28px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn-save:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-cancel {
    background: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-muted);
    padding: 12px 24px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn-cancel:hover {
    border-color: var(--text-muted);
    color: var(--text-color);
}

/* ç¦ç”¨å¤©æ•°é€‰æ‹©å™¨ */
.disable-days-selector {
    padding: 10px 0;
}

.disable-days-selector .text-muted {
    color: #6b7280;
    font-size: 14px;
    margin-bottom: 20px;
}

.disable-days-selector .text-info {
    color: #3b82f6;
    font-size: 13px;
    margin-top: 16px;
    padding: 10px;
    background: #eff6ff;
    border-radius: 6px;
}

.days-options {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin: 20px 0;
}

.day-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100px;
    height: 100px;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    background: #fff;
    cursor: pointer;
    transition: all 0.2s;
}

.day-btn:hover {
    border-color: #3b82f6;
    background: #eff6ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.day-btn:active {
    transform: translateY(0);
}

.day-number {
    font-size: 32px;
    font-weight: 700;
    color: #3b82f6;
}

.day-label {
    font-size: 14px;
    color: #6b7280;
    margin-top: 4px;
}

/* å“åº”å¼ */
@media (max-width: 768px) {
    .config-header-info {
        flex-direction: column;
        gap: 16px;
    }

    .config-header-title {
        flex-direction: column;
        text-align: center;
    }

    .config-actions {
        width: 100%;
        justify-content: center;
    }

    .config-form-grid {
        grid-template-columns: 1fr;
    }

    .form-actions-full {
        flex-direction: column;
    }

    .btn-save,
    .btn-cancel {
        width: 100%;
        justify-content: center;
    }

    .config-table {
        font-size: 12px;
    }

    .config-table thead th,
    .config-table tbody td {
        padding: 10px 8px;
    }

    .list-filters {
        flex-direction: column;
    }

    .filter-group {
        width: 100%;
    }

    .filter-group select {
        width: 100%;
    }
}
</style>

<script>
let currentConfigId = null;
let allEnvs = [];  // å­˜å‚¨æ‰€æœ‰ç”¨æˆ·çš„ç¯å¢ƒå˜é‡
let availableIPs = [];
let managedUsers = [];
const currentUser = getCurrentUser();

// ==================== å·¥å…·å‡½æ•° ====================

/**
 * å‘èµ· API è¯·æ±‚
 */
async function apiRequest(url, options = {}) {
    const defaultOpts = {
        headers: { 'Content-Type': 'application/json' },
    };
    const token = localStorage.getItem('access_token');
    if (token) {
        defaultOpts.headers['Authorization'] = `Bearer ${token}`;
    }
    const finalOpts = { ...defaultOpts, ...options };
    if (finalOpts.body && typeof finalOpts.body === 'object') {
        finalOpts.body = JSON.stringify(finalOpts.body);
    }
    const response = await fetch(`/api${url}`, finalOpts);
    if (response.status === 204) return null;
    const data = await response.json();
    if (!response.ok) {
        throw new Error(data.detail || data.message || 'è¯·æ±‚å¤±è´¥');
    }
    return data;
}

/**
 * è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯
 */
function getCurrentUser() {
    const userStr = localStorage.getItem('current_user');
    if (userStr) {
        try {
            return JSON.parse(userStr);
        } catch (e) {
            return null;
        }
    }
    return null;
}

/**
 * æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
 */
function showToast(message, type = 'info') {
    const existing = document.querySelector('.toast-message');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.className = `toast-message toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#6366f1'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease;
        font-size: 14px;
    `;

    if (!document.querySelector('#toast-style')) {
        const style = document.createElement('style');
        style.id = 'toast-style';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }

    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ==================== ä¸»è¦åŠŸèƒ½å‡½æ•° ====================

/**
 * åŠ è½½æ‰€æœ‰å¯ç®¡ç†ç”¨æˆ·çš„ç¯å¢ƒå˜é‡
 */
async function loadAllEnvs() {
    try {
        const tbody = document.getElementById('envTableBody');
        tbody.innerHTML = '<tr><td colspan="8" class="loading-cell">åŠ è½½ä¸­...</td></tr>';

        // è·å–å¯ç®¡ç†ç”¨æˆ·åˆ—è¡¨
        const usersRes = await apiRequest('/config-envs/managed-users');
        managedUsers = usersRes && usersRes.data ? usersRes.data : [];

        if (!managedUsers.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="loading-cell">æš‚æ— å¯ç®¡ç†çš„ç”¨æˆ·</td></tr>';
            updateEnvCount(0);
            return;
        }

        // ä¸ºæ¯ä¸ªç”¨æˆ·è·å–ç¯å¢ƒå˜é‡
        allEnvs = [];
        for (const user of managedUsers) {
            try {
                // ç¡®ä¿ç”¨æˆ·æœ‰é»˜è®¤é…ç½®å¹¶è·å–config_id
                const configRes = await apiRequest(`/config-envs/users/${user.id}/default-config`, { method: 'POST' });
                const configId = configRes && configRes.config_id;

                if (configId) {
                    // è·å–ç¯å¢ƒå˜é‡
                    const envs = await apiRequest(`/config-envs/configs/${configId}/envs`);
                    if (envs && envs.length) {
                        envs.forEach(env => {
                            allEnvs.push({
                                ...env,
                                user_id: user.id,
                                user_name: user.username,
                                user_nickname: user.nickname,
                                user_role: user.role,
                                config_id: configId
                            });
                        });
                    }
                }
            } catch (err) {
                console.error(`åŠ è½½ç”¨æˆ· ${user.id} çš„ç¯å¢ƒå˜é‡å¤±è´¥:`, err);
            }
        }

        // æ›´æ–°ç”¨æˆ·ç­›é€‰å™¨
        updateUserFilter();
        applyUserFilterFromUrl();

        // æ¸²æŸ“è¡¨æ ¼
        renderEnvTable();

        // åŠ è½½å¯ç”¨IP
        await loadAvailableIPs();

    } catch (err) {
        console.error(err);
        showToast(err.message || 'åŠ è½½æ•°æ®å¤±è´¥', 'error');
        document.getElementById('envTableBody').innerHTML = '<tr><td colspan="8" class="loading-cell">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
    }
}

function applyUserFilterFromUrl() {
    try {
        const params = new URLSearchParams(window.location.search);
        const userId = params.get('user_id');
        if (!userId) return;
        const filter = document.getElementById('userFilter');
        if (!filter) return;
        const exists = Array.from(filter.options).some(opt => String(opt.value) === String(userId));
        if (exists) filter.value = userId;
    } catch (e) {
        console.error('è§£æ user_id å¤±è´¥:', e);
    }
}

/**
 * æ›´æ–°ç”¨æˆ·ç­›é€‰å™¨
 */
function updateUserFilter() {
    const filter = document.getElementById('userFilter');
    filter.innerHTML = '<option value="">å…¨éƒ¨ç”¨æˆ·</option>';
    managedUsers.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = `${u.username}${u.nickname ? 'ï¼ˆ'+u.nickname+'ï¼‰' : ''}`;
        filter.appendChild(opt);
    });

    // åŒæ—¶æ›´æ–°è¡¨å•ä¸­çš„ç”¨æˆ·é€‰æ‹©å™¨
    const formSelect = document.getElementById('formUserSelect');
    formSelect.innerHTML = '';
    managedUsers.forEach(u => {
        const opt = document.createElement('option');
        opt.value = u.id;
        opt.textContent = `${u.username}${u.nickname ? 'ï¼ˆ'+u.nickname+'ï¼‰' : ''}`;
        formSelect.appendChild(opt);
    });
}

/**
 * æ¸²æŸ“ç¯å¢ƒå˜é‡è¡¨æ ¼
 */
function renderEnvTable() {
    const tbody = document.getElementById('envTableBody');
    const userFilter = document.getElementById('userFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;

    // åº”ç”¨ç­›é€‰
    let filteredEnvs = allEnvs;
    if (userFilter) {
        filteredEnvs = filteredEnvs.filter(env => String(env.user_id) === String(userFilter));
    }
    if (statusFilter) {
        filteredEnvs = filteredEnvs.filter(env => env.status === statusFilter);
    }

    if (!filteredEnvs.length) {
        const msg = allEnvs.length === 0 ? 'æš‚æ— ç¯å¢ƒå˜é‡ï¼Œç‚¹å‡»"æ–°å¢å˜é‡"æ·»åŠ ' : 'æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„æ•°æ®';
        tbody.innerHTML = `<tr><td colspan="8" class="loading-cell">${msg}</td></tr>`;
        updateEnvCount(0);
        return;
    }

    tbody.innerHTML = '';
    filteredEnvs.forEach(env => {
        const tr = document.createElement('tr');
        const ipInfo = env.ip_info || {};

        let statusHtml = '';
        if (env.status === 'valid') {
            statusHtml = '<span class="status-badge valid"><span class="status-dot"></span>å¯ç”¨</span>';
        } else {
            if (env.disabled_until) {
                const remaining = getRemainingTime(env.disabled_until);
                statusHtml = `<span class="status-badge invalid"><span class="status-dot"></span>ç¦ç”¨</span><br><small class="countdown">${remaining}</small>`;
            } else {
                statusHtml = '<span class="status-badge disabled"><span class="status-dot"></span>ç¦ç”¨</span>';
            }
        }

        // ç”¨æˆ·è§’è‰²æ ‡ç­¾
        const roleLabels = { admin: 'ç®¡ç†å‘˜', agent: 'ä»£ç†', normal: 'æ™®é€š' };
        const roleClass = { admin: 'role-admin', agent: 'role-agent', normal: 'role-normal' };
        const userRoleBadge = `<span class="user-role-badge ${roleClass[env.user_role] || 'role-normal'}">${roleLabels[env.user_role] || 'æ™®é€š'}</span>`;

        tr.innerHTML = `
            <td class="col-id">${env.id}</td>
            <td class="col-user">
                <div class="user-info-cell">
                    <span class="user-name">${env.user_name}</span>
                    ${env.user_nickname ? `<span class="user-nickname">${env.user_nickname}</span>` : ''}
                    ${userRoleBadge}
                </div>
            </td>
            <td class="col-name">${env.env_name}</td>
            <td class="col-value"><span class="text-ellipsis" title="${env.env_value || ''}">${env.env_value || '-'}</span></td>
            <td class="col-ip">
                ${env.ip_id ? `
                    <div class="text-ellipsis" title="${ipInfo.proxy_url || ''}">${ipInfo.proxy_url || '-'}</div>
                    <div style="font-size:11px;color:#94a3b8;margin-top:2px;">${ipInfo.region || ''} ${ipInfo.vendor ? '('+ipInfo.vendor+')' : ''}</div>
                    <div style="font-size:10px;color:#94a3b8;">å®¹é‡: ${ipInfo.used || 0}/${ipInfo.max_users || 2}</div>
                ` : '<span style="color:#94a3b8;">æœªé…ç½®</span>'}
            </td>
            <td class="col-status">${statusHtml}</td>
            <td class="col-remark"><span class="text-ellipsis" style="max-width:100px;" title="${env.remark || ''}">${env.remark || '-'}</span></td>
            <td class="col-actions">
                <div class="table-actions">
                    <button class="btn-link" onclick="editEnv(${env.id}, ${env.config_id})">ç¼–è¾‘</button>
                    <button class="btn-link" onclick="${env.status === 'valid' ? 'disableEnv' : 'enableEnv'}(${env.id}, ${env.config_id})">${env.status === 'valid' ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                    <button class="btn-link danger" onclick="deleteEnv(${env.id}, ${env.config_id})">åˆ é™¤</button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });

    updateEnvCount(filteredEnvs.length);
}

function updateEnvCount(count) {
    const badge = document.getElementById('envCountBadge');
    if (badge) {
        badge.textContent = `${count} æ¡è®°å½•`;
    }
}

function getRemainingTime(disabledUntilStr) {
    const now = new Date();
    const disabledUntil = new Date(disabledUntilStr);
    const diff = disabledUntil - now;

    if (diff <= 0) return 'å³å°†æ¢å¤';

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

    if (days > 0) {
        return `å‰©ä½™${days}å¤©${hours}å°æ—¶`;
    } else {
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        return `å‰©ä½™${hours}å°æ—¶${minutes}åˆ†`;
    }
}

async function loadAvailableIPs() {
    try {
        const res = await apiRequest('/config-envs/ip-pool/available');
        availableIPs = (res && res.data) ? res.data : [];
        renderIPOptions();
    } catch (err) {
        console.error(err);
        availableIPs = [];
    }
}

function renderIPOptions(selectedId = '') {
    const sel = document.getElementById('ipSelect');
    sel.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'è¯·é€‰æ‹©IP';
    placeholder.disabled = true;
    placeholder.selected = !selectedId;
    sel.appendChild(placeholder);
    availableIPs.forEach(ip => {
        const disabled = ip.used >= (ip.max_users || 2);
        if (disabled && String(ip.id) !== String(selectedId)) return;
        const labelParts = [
            ip.proxy_url || '',
            ip.region || '',
            ip.vendor ? `(${ip.vendor})` : '',
            `å®¹é‡:${ip.used}/${ip.max_users || 2}`
        ].filter(Boolean);
        const opt = document.createElement('option');
        opt.value = ip.id;
        opt.textContent = labelParts.join(' ');
        if (String(selectedId) === String(ip.id)) opt.selected = true;
        sel.appendChild(opt);
    });
}

function computeNextEnvName() {
    return apiRequest('/config-envs/next-name')
        .then(res => res.next_name || 'ksck1')
        .catch(() => 'ksck1');
}

function showForm() {
    document.getElementById('formCard').style.display = 'block';
    document.getElementById('formCard').scrollIntoView({ behavior: 'smooth' });
}

function hideForm() {
    document.getElementById('formCard').style.display = 'none';
}

function resetForm() {
    document.getElementById('envId').value = '';
    document.getElementById('envValue').value = '';
    document.getElementById('envRemark').value = '';
    document.getElementById('ipSelect').value = '';
    document.getElementById('formUserSelect').value = managedUsers.length > 0 ? managedUsers[0].id : '';
    computeNextEnvName().then(name => {
        document.getElementById('autoEnvName').textContent = `å°†ç”Ÿæˆ ${name}`;
    });
}

function editEnv(envId, configId) {
    const env = allEnvs.find(e => e.id === envId && e.config_id === configId);
    if (!env) return;

    currentConfigId = configId;
    document.getElementById('envId').value = env.id;
    document.getElementById('envValue').value = env.env_value;
    document.getElementById('envRemark').value = env.remark || '';
    document.getElementById('formUserSelect').value = env.user_id;
    renderIPOptions(env.ip_id || '');
    document.getElementById('ipSelect').value = env.ip_id ? String(env.ip_id) : '';
    document.getElementById('autoEnvName').textContent = env.env_name;

    showForm();
}

async function saveEnv(e) {
    e.preventDefault();

    const envId = document.getElementById('envId').value;
    const cookie = document.getElementById('envValue').value.trim();
    const remark = document.getElementById('envRemark').value.trim();
    const ipIdStr = document.getElementById('ipSelect').value;
    const targetUserId = document.getElementById('formUserSelect').value;

    if (!targetUserId) {
        showToast('è¯·é€‰æ‹©ç”¨æˆ·', 'warning');
        return;
    }
    if (!cookie) {
        showToast('ksck ä¸èƒ½ä¸ºç©º', 'warning');
        return;
    }
    if (!remark) {
        showToast('å¤‡æ³¨ä¸èƒ½ä¸ºç©ºï¼ˆç”¨äºæ”¶ç›Šç»Ÿè®¡å”¯ä¸€æ ‡è¯†ï¼‰', 'warning');
        return;
    }
    if (!ipIdStr) {
        showToast('è¯·é€‰æ‹©IP', 'warning');
        return;
    }

    const ipId = Number.parseInt(ipIdStr, 10);
    if (!Number.isFinite(ipId)) {
        showToast('IP é€‰æ‹©æ— æ•ˆï¼Œè¯·é‡æ–°é€‰æ‹©', 'warning');
        return;
    }

    // è·å–ç›®æ ‡ç”¨æˆ·çš„config_id
    try {
        const configRes = await apiRequest(`/config-envs/users/${targetUserId}/default-config`, { method: 'POST' });
        const targetConfigId = configRes && configRes.config_id;

        if (!targetConfigId) {
            showToast('è·å–ç”¨æˆ·é…ç½®å¤±è´¥', 'error');
            return;
        }

        // æ™®é€šç”¨æˆ·æ£€æŸ¥
        if (!envId && currentUser && currentUser.role === 'normal' && String(targetUserId) === String(currentUser.id)) {
            showToast('æ™®é€šç”¨æˆ·æ— æƒä¸ºè‡ªå·±æ–°å¢ç¯å¢ƒå˜é‡', 'error');
            return;
        }

        const payload = {
            cookie,
            remark,
            ip_id: ipId
        };

        if (envId) {
            await apiRequest(`/config-envs/configs/${currentConfigId}/envs/${envId}`, {
                method: 'PUT',
                body: JSON.stringify(payload)
            });
            showToast('æ›´æ–°æˆåŠŸ', 'success');
        } else {
            await apiRequest(`/config-envs/configs/${targetConfigId}/envs`, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            showToast('æ–°å¢æˆåŠŸ', 'success');
        }

        resetForm();
        hideForm();
        await loadAllEnvs();

    } catch (err) {
        console.error(err);
        showToast(err.message || 'ä¿å­˜å¤±è´¥', 'error');
    }
}

async function deleteEnv(envId, configId) {
    if (!confirm('ç¡®è®¤åˆ é™¤è¯¥ç¯å¢ƒå˜é‡ï¼Ÿ')) return;
    try {
        await apiRequest(`/config-envs/configs/${configId}/envs/${envId}`, {
            method: 'DELETE'
        });
        showToast('å·²åˆ é™¤', 'success');
        await loadAllEnvs();
    } catch (err) {
        console.error(err);
        showToast(err.message || 'åˆ é™¤å¤±è´¥', 'error');
    }
}

async function enableEnv(envId, configId) {
    try {
        await apiRequest(`/config-envs/configs/${configId}/envs/${envId}/enable`, { method: 'POST' });
        showToast('å·²å¯ç”¨', 'success');
        await loadAllEnvs();
    } catch (err) {
        console.error(err);
        showToast(err.message || 'å¯ç”¨å¤±è´¥', 'error');
    }
}

async function disableEnv(envId, configId) {
    currentConfigId = configId;
    showDisableDaysModal(envId);
}

function showDisableDaysModal(envId) {
    const modal = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalFooter = document.getElementById('modalFooter');

    modalTitle.textContent = 'é€‰æ‹©ç¦ç”¨å¤©æ•°';

    modalBody.innerHTML = `
        <div class="disable-days-selector">
            <p class="text-muted">é€‰æ‹©ç¦ç”¨å¤©æ•°ï¼Œåˆ°æœŸåå°†è‡ªåŠ¨å¯ç”¨ï¼š</p>
            <div class="days-options">
                <button class="day-btn" data-days="3">
                    <span class="day-number">3</span>
                    <span class="day-label">å¤©</span>
                </button>
                <button class="day-btn" data-days="5">
                    <span class="day-number">5</span>
                    <span class="day-label">å¤©</span>
                </button>
                <button class="day-btn" data-days="7">
                    <span class="day-number">7</span>
                    <span class="day-label">å¤©</span>
                </button>
            </div>
            <p class="text-info">ç¦ç”¨åï¼Œè¯¥ç¯å¢ƒå˜é‡å°†åœ¨é€‰å®šçš„å¤©æ•°åè‡ªåŠ¨æ¢å¤å¯ç”¨çŠ¶æ€ã€‚</p>
        </div>
    `;

    modalFooter.innerHTML = `
        <button class="btn btn-secondary" onclick="closeGlobalModal()">å–æ¶ˆ</button>
    `;

    modal.style.display = 'flex';

    document.querySelectorAll('.day-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const days = parseInt(this.dataset.days);
            await confirmDisableEnv(envId, days);
        });
    });
}

async function confirmDisableEnv(envId, days) {
    try {
        const res = await apiRequest(`/config-envs/configs/${currentConfigId}/envs/${envId}/disable`, {
            method: 'POST',
            body: JSON.stringify({ days: days })
        });
        showToast(res.message || `å·²ç¦ç”¨ï¼Œå°†åœ¨${days}å¤©åè‡ªåŠ¨æ¢å¤`, 'success');
        closeGlobalModal();
        await loadAllEnvs();
    } catch (err) {
        console.error(err);
        showToast(err.message || 'ç¦ç”¨å¤±è´¥', 'error');
    }
}

// ==================== äº‹ä»¶ç›‘å¬ ====================

document.getElementById('envForm').addEventListener('submit', saveEnv);
document.getElementById('refreshAll').addEventListener('click', async () => {
    await loadAllEnvs();
});
document.getElementById('startCreateEnv').addEventListener('click', async () => {
    if (!managedUsers.length) {
        showToast('æš‚æ— å¯ç®¡ç†çš„ç”¨æˆ·', 'warning');
        return;
    }
    resetForm();
    showForm();
});
document.getElementById('closeFormBtn').addEventListener('click', hideForm);
document.getElementById('cancelEdit').addEventListener('click', () => {
    resetForm();
    hideForm();
});

document.getElementById('userFilter').addEventListener('change', renderEnvTable);
document.getElementById('statusFilter').addEventListener('change', renderEnvTable);

// åˆå§‹åŒ–
loadAllEnvs();
</script>
{% endblock %}
