{% extends "base.html" %}

{% block title %}用户管理 - 快手账号管理平台{% endblock %}

{% block page_title %}用户管理{% endblock %}

{% block content %}
<div class="page-actions">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="搜索用户名/手机号..." onkeyup="handleSearch(event)">
        <button class="btn btn-secondary" onclick="searchUsers()">搜索</button>
    </div>
</div>

<div class="filter-bar">
    <div class="filter-group">
        <label>角色:</label>
        <select id="roleFilter" onchange="filterUsers()">
            <option value="">全部</option>
            <option value="admin">管理员</option>
            <option value="agent">代理</option>
            <option value="normal">普通用户</option>
        </select>
    </div>
    <div class="filter-group">
        <label>状态:</label>
        <select id="statusFilter" onchange="filterUsers()">
            <option value="">全部</option>
            <option value="1">正常</option>
            <option value="0">禁用</option>
        </select>
    </div>
    <div class="filter-stats">
        <span>共 <strong id="totalCount">0</strong> 个用户</span>
    </div>
</div>

<div class="data-card">
    <div class="table-responsive">
        <table class="data-table" id="usersTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>用户名</th>
                    <th>昵称</th>
                    <th>手机号</th>
                    <th>微信ID</th>
                    <th>角色</th>
                    <th>状态</th>
                    <th>注册时间</th>
                    <th style="width:160px;">操作</th>
                </tr>
            </thead>
            <tbody id="usersTableBody">
                <tr><td colspan="9" class="loading-cell">加载中...</td></tr>
            </tbody>
        </table>
    </div>
</div>
<style>
.filter-group select {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
}
.btn.btn-sm {
    padding: 6px 10px;
    font-size: 12px;
    border-radius: 6px;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    cursor: pointer;
}
.btn.btn-sm:hover { background: #e5e7eb; }
.btn.btn-sm.danger {
    background: #fee2e2;
    border-color: #fecdd3;
    color: #b91c1c;
}
</style>

<!-- 编辑用户模态框 -->
<div class="modal-overlay" id="userModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>编辑用户</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="userForm">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label>用户名</label>
                    <input type="text" id="userUsername" disabled>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>昵称</label>
                        <input type="text" id="userNickname" placeholder="昵称">
                    </div>
                    <div class="form-group">
                        <label>手机号</label>
                        <input type="text" id="userPhone" placeholder="手机号">
                    </div>
                </div>
                <div class="form-group">
                    <label>微信ID</label>
                    <input type="text" id="userWechatId" placeholder="微信ID">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>角色</label>
                        <select id="userRole">
                            <option value="admin">管理员</option>
                            <option value="agent">代理</option>
                            <option value="normal">普通用户</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>状态</label>
                        <select id="userStatus">
                            <option value="1">正常</option>
                            <option value="0">禁用</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">取消</button>
            <button class="btn btn-primary" onclick="saveUser()">保存</button>
        </div>
    </div>
</div>

<script>
let allUsers = [];
const currentUser = getCurrentUser();

document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
});

async function loadUsers() {
    const tbody = document.getElementById('usersTableBody');
    try {
        allUsers = await apiRequest('/admin/users');
        renderUsers(allUsers);
        document.getElementById('totalCount').textContent = allUsers.length;
    } catch (error) {
        tbody.innerHTML = '<tr><td colspan="9" class="error-cell">加载失败: ' + error.message + '</td></tr>';
    }
}

function renderUsers(users) {
    const tbody = document.getElementById('usersTableBody');
    if (!users || users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-cell">暂无用户数据</td></tr>';
        return;
    }
    
    const roleMap = { 'admin': '管理员', 'agent': '代理', 'normal': '普通用户' };
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>${user.id}</td>
            <td><strong>${user.username}</strong></td>
            <td>${user.nickname || '-'}</td>
            <td>${user.phone || '-'}</td>
            <td>${user.wechat_id || '-'}</td>
            <td><span class="role-badge role-${user.role}">${roleMap[user.role] || user.role}</span></td>
            <td><span class="status-badge ${user.status === 1 ? 'status-normal' : 'status-disabled'}">${user.status === 1 ? '正常' : '禁用'}</span></td>
            <td>${new Date(user.created_at).toLocaleDateString('zh-CN')}</td>
            <td class="action-cell">
                <div class="btn-group-inline">
                    <button class="btn btn-sm" onclick="editUser(${user.id})" title="编辑">编辑</button>
                    <button class="btn btn-sm" onclick="toggleUserStatus(${user.id})" title="启用/禁用">${user.status === 1 ? '禁用' : '启用'}</button>
                    <button class="btn btn-sm danger" onclick="deleteUser(${user.id})" title="删除">删除</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function filterUsers() {
    const role = document.getElementById('roleFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    let filtered = allUsers;
    if (role) filtered = filtered.filter(u => u.role === role);
    if (status !== '') filtered = filtered.filter(u => u.status === parseInt(status));
    
    renderUsers(filtered);
    document.getElementById('totalCount').textContent = filtered.length;
}

function handleSearch(event) {
    if (event.key === 'Enter') searchUsers();
}

function searchUsers() {
    const keyword = document.getElementById('searchInput').value.toLowerCase();
    const filtered = allUsers.filter(u => 
        u.username.toLowerCase().includes(keyword) ||
        (u.phone && u.phone.includes(keyword)) ||
        (u.nickname && u.nickname.toLowerCase().includes(keyword))
    );
    renderUsers(filtered);
    document.getElementById('totalCount').textContent = filtered.length;
}

function closeModal() {
    document.getElementById('userModal').style.display = 'none';
}

function editUser(id) {
    const user = allUsers.find(u => u.id === id);
    if (!user) return;
    
    document.getElementById('userId').value = user.id;
    document.getElementById('userUsername').value = user.username;
    document.getElementById('userNickname').value = user.nickname || '';
    document.getElementById('userPhone').value = user.phone || '';
    document.getElementById('userWechatId').value = user.wechat_id || '';
    document.getElementById('userRole').value = user.role;
    document.getElementById('userStatus').value = user.status;
    document.getElementById('userModal').style.display = 'flex';
}

async function saveUser() {
    const id = document.getElementById('userId').value;
    const data = {
        nickname: document.getElementById('userNickname').value || null,
        phone: document.getElementById('userPhone').value || null,
        wechat_id: document.getElementById('userWechatId').value || null,
        role: document.getElementById('userRole').value,
        status: parseInt(document.getElementById('userStatus').value)
    };
    
    try {
        await apiRequest(`/admin/users/${id}`, { method: 'PUT', body: JSON.stringify(data) });
        showToast('用户更新成功', 'success');
        closeModal();
        loadUsers();
    } catch (error) {
        showToast('更新失败: ' + error.message, 'error');
    }
}

async function toggleUserStatus(id) {
    const user = allUsers.find(u => u.id === id);
    if (!user) return;
    
    const newStatus = user.status === 1 ? 0 : 1;
    const action = newStatus === 1 ? '启用' : '禁用';
    
    if (!confirm(`确定要${action}用户 ${user.username} 吗？`)) return;
    
    try {
        await apiRequest(`/admin/users/${id}`, {
            method: 'PUT',
            body: JSON.stringify({ status: newStatus })
        });
        showToast(`已${action}`, 'success');
        loadUsers();
    } catch (error) {
        showToast('操作失败: ' + error.message, 'error');
    }
}

function viewReferrals(userId) {
    window.location.href = `/admin/referrals?user_id=${userId}`;
}

async function deleteUser(id) {
    const user = allUsers.find(u => u.id === id);
    if (!user) return;
    if (currentUser && currentUser.id === id) {
        showToast('不能删除自己', 'warning');
        return;
    }
    if (!confirm(`确定要删除用户 ${user.username} 吗？此操作不可恢复。`)) return;
    try {
        await apiRequest(`/admin/users/${id}`, { method: 'DELETE' });
        showToast('已删除', 'success');
        loadUsers();
    } catch (error) {
        showToast('删除失败: ' + error.message, 'error');
    }
}
</script>
{% endblock %}
