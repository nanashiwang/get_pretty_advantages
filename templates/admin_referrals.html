{% extends "base.html" %}

{% block title %}æ¨å¹¿å…³ç³»ç®¡ç† - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}æ¨å¹¿å…³ç³»ç®¡ç†{% endblock %}

{% block content %}
<div class="stats-overview">
    <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-content">
            <span class="stat-value" id="totalReferrals">0</span>
            <span class="stat-label">æ€»æ¨å¹¿å…³ç³»</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ”—</div>
        <div class="stat-content">
            <span class="stat-value" id="level1Count">0</span>
            <span class="stat-label">+1å…³ç³»æ•°</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">â›“ï¸</div>
        <div class="stat-content">
            <span class="stat-value" id="level2Count">0</span>
            <span class="stat-label">+2å…³ç³»æ•°</span>
        </div>
    </div>
</div>

<div class="filter-bar">
    <div class="filter-group">
        <label>æŸ¥æ‰¾ç”¨æˆ·:</label>
        <input type="text" id="searchUser" placeholder="è¾“å…¥ç”¨æˆ·åæˆ–ID" onkeyup="handleSearch(event)">
        <button class="btn btn-secondary btn-sm" onclick="searchReferrals()">æœç´¢</button>
    </div>
</div>

<div class="data-card">
    <div class="card-header">
        <h3>æ¨å¹¿å…³ç³»åˆ—è¡¨</h3>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="referralsTable">
            <thead>
                <tr>
                    <th>è¢«é‚€è¯·äºº</th>
                    <th>è¢«é‚€è¯·äººä¿¡æ¯</th>
                    <th>+1 (ç›´æ¥é‚€è¯·äºº)</th>
                    <th>+2 (ä¸Šçº§é‚€è¯·äºº)</th>
                    <th>å»ºç«‹æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="referralsTableBody">
                <tr><td colspan="5" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- æ¨å¹¿é“¾è·¯è¯¦æƒ… -->
<div class="data-card">
    <div class="card-header">
        <h3>æ¨å¹¿é“¾è·¯æŸ¥è¯¢</h3>
    </div>
    <div class="card-body">
        <div class="referral-chain" id="referralChain">
            <p class="info-text">é€‰æ‹©ä¸€ä¸ªç”¨æˆ·æŸ¥çœ‹å…¶å®Œæ•´æ¨å¹¿é“¾è·¯</p>
        </div>
    </div>
</div>

<script>
let referrals = [];

function userDisplayName(user, fallbackId) {
    if (!user) return fallbackId ? String(fallbackId) : '-';
    return user.username || user.nickname || String(user.id);
}

function userExtraInfo(user) {
    if (!user) return '-';
    return user.nickname || user.phone || '-';
}

document.addEventListener('DOMContentLoaded', async function() {
    await loadReferrals();
    
    // æ£€æŸ¥URLå‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('user_id');
    if (userId) {
        document.getElementById('searchUser').value = userId;
        searchReferrals();
    }
});

async function loadReferrals() {
    const tbody = document.getElementById('referralsTableBody');
    try {
        referrals = await apiRequest('/referrals');
        renderReferrals(referrals);
        updateStats();
    } catch (error) {
        tbody.innerHTML = '<tr><td colspan="5" class="error-cell">åŠ è½½å¤±è´¥: ' + error.message + '</td></tr>';
    }
}

function renderReferrals(data) {
    const tbody = document.getElementById('referralsTableBody');
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-cell">æš‚æ— æ¨å¹¿å…³ç³»æ•°æ®</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(ref => {
        const user = ref.user || null;
        const inviter1 = ref.inviter1 || null;
        const inviter2 = ref.inviter2 || null;
        
        return `
            <tr onclick="showChain(${ref.user_id})" style="cursor: pointer;">
                <td><strong>${userDisplayName(user, ref.user_id)}</strong></td>
                <td>${userExtraInfo(user)}</td>
                <td>
                    ${inviter1 ? `<span class="user-tag">ğŸ‘¤ ${inviter1.username}</span>` : '<span class="text-muted">-</span>'}
                </td>
                <td>
                    ${inviter2 ? `<span class="user-tag">ğŸ‘¤ ${inviter2.username}</span>` : '<span class="text-muted">-</span>'}
                </td>
                <td>${new Date(ref.created_at).toLocaleDateString('zh-CN')}</td>
            </tr>
        `;
    }).join('');
}

function updateStats() {
    document.getElementById('totalReferrals').textContent = referrals.length;
    document.getElementById('level1Count').textContent = referrals.filter(r => r.inviter_level1).length;
    document.getElementById('level2Count').textContent = referrals.filter(r => r.inviter_level2).length;
}

function handleSearch(event) {
    if (event.key === 'Enter') searchReferrals();
}

function searchReferrals() {
    const keyword = document.getElementById('searchUser').value.toLowerCase();
    if (!keyword) {
        renderReferrals(referrals);
        return;
    }
    
    const filtered = referrals.filter(ref => {
        const kw = keyword.trim();
        if (!kw) return true;

        const user = ref.user || null;
        const inviter1 = ref.inviter1 || null;
        const inviter2 = ref.inviter2 || null;

        return (
            String(ref.user_id) === kw
            || (user && (
                (user.username || '').toLowerCase().includes(kw)
                || (user.nickname || '').toLowerCase().includes(kw)
            ))
            || (inviter1 && (
                String(ref.inviter_level1 || '') === kw
                || (inviter1.username || '').toLowerCase().includes(kw)
                || (inviter1.nickname || '').toLowerCase().includes(kw)
            ))
            || (inviter2 && (
                String(ref.inviter_level2 || '') === kw
                || (inviter2.username || '').toLowerCase().includes(kw)
                || (inviter2.nickname || '').toLowerCase().includes(kw)
            ))
        );
    });
    
    renderReferrals(filtered);
    
    // å¦‚æœåªæœ‰ä¸€ä¸ªç»“æœï¼Œæ˜¾ç¤ºé“¾è·¯
    if (filtered.length === 1) {
        showChain(filtered[0].user_id);
    }
}

function showChain(userId) {
    const container = document.getElementById('referralChain');
    const userIdNum = Number(userId);
    const ref = referrals.find(r => Number(r.user_id) === userIdNum);
    
    if (!ref) {
        container.innerHTML = '<p class="info-text">è¯¥ç”¨æˆ·æ— æ¨å¹¿å…³ç³»</p>';
        return;
    }
    
    const user = ref.user || null;
    const inviter1 = ref.inviter1 || null;
    const inviter2 = ref.inviter2 || null;
    
    // æŸ¥æ‰¾è¯¥ç”¨æˆ·é‚€è¯·çš„ä¸‹çº§
    const myInvitees = referrals.filter(r => Number(r.inviter_level1) === userIdNum);
    
    container.innerHTML = `
        <div class="chain-diagram">
            ${inviter2 ? `
                <div class="chain-node level2">
                    <div class="node-icon">ğŸ‘¤</div>
                    <div class="node-info">
                        <span class="node-label">+2 ä¸Šçº§</span>
                        <span class="node-name">${userDisplayName(inviter2, ref.inviter_level2)}</span>
                    </div>
                </div>
                <div class="chain-arrow">â†“</div>
            ` : ''}
            ${inviter1 ? `
                <div class="chain-node level1">
                    <div class="node-icon">ğŸ‘¤</div>
                    <div class="node-info">
                        <span class="node-label">+1 ç›´æ¥é‚€è¯·äºº</span>
                        <span class="node-name">${userDisplayName(inviter1, ref.inviter_level1)}</span>
                    </div>
                </div>
                <div class="chain-arrow">â†“</div>
            ` : ''}
            <div class="chain-node current">
                <div class="node-icon">â­</div>
                <div class="node-info">
                    <span class="node-label">å½“å‰ç”¨æˆ·</span>
                    <span class="node-name">${userDisplayName(user, userId)}</span>
                </div>
            </div>
            ${myInvitees.length > 0 ? `
                <div class="chain-arrow">â†“</div>
                <div class="chain-invitees">
                    <span class="invitees-label">æˆ‘é‚€è¯·çš„ç”¨æˆ· (${myInvitees.length}äºº)</span>
                    <div class="invitees-list">
                        ${myInvitees.slice(0, 5).map(inv => {
                            return `<span class="invitee-tag">${userDisplayName(inv.user || null, inv.user_id)}</span>`;
                        }).join('')}
                        ${myInvitees.length > 5 ? `<span class="invitee-more">+${myInvitees.length - 5}äºº</span>` : ''}
                    </div>
                </div>
            ` : ''}
        </div>
    `;
}
</script>
{% endblock %}
