{% extends "base.html" %}

{% block title %}收益统计 - 快手账号管理平台{% endblock %}

{% block page_title %}收益统计{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header between">
        <div>
            <h3>收益统计</h3>
            <p class="text-muted">支持快捷选择与自定义范围；数据按日志日期汇总到每日收益（10000 金币 = 1 元）。</p>
        </div>
    </div>
    <div class="card-body">
        <div class="filter-bar">
            <div class="filter-group">
                <label>统计周期:</label>
                <div class="btn-group" id="quickRanges">
                    <button type="button" class="btn btn-secondary btn-sm" data-range="today">今日</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-range="yesterday">昨日</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-range="7d">近7天</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-range="30d">近30天</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-range="all">全部</button>
                </div>
            </div>
            <div class="filter-group">
                <label>自定义:</label>
                <input type="date" id="startDate">
                <span>至</span>
                <input type="date" id="endDate">
                <button type="button" class="btn btn-primary btn-sm" id="applyRange">应用</button>
            </div>
            <div class="filter-group filter-right">
                <small class="text-muted" id="viewerInfo"></small>
            </div>
        </div>

        <div class="stats-overview">
            <div class="stat-card highlight">
                <div class="stat-icon">¥</div>
                <div class="stat-content">
                    <span class="stat-value" id="ownedTotalYuan">¥0.00</span>
                    <span class="stat-label">名下账号收入</span>
                    <small class="text-muted" id="ownedTotalCoins">0 金币</small>
                    <small class="text-muted" id="ownedRangeLabel">周期 -</small>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">Σ</div>
                <div class="stat-content">
                    <span class="stat-value" id="periodTotalYuan">¥0.00</span>
                    <span class="stat-label">本周期总收入</span>
                    <small class="text-muted" id="periodTotalCoins">0 金币</small>
                    <small class="text-muted" id="periodRangeLabel">周期 -</small>
                    <small class="text-muted" id="periodFormulaLabel">本周期总收入 = 我*100% + 一级下级*20% + 二级下级*4%</small>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3>分层贡献（本周期）</h3>
                </div>
                <div class="card-body">
                    <div class="stats-overview">
                        <div class="stat-card">
                            <div class="stat-icon">我</div>
                            <div class="stat-content">
                                <span class="stat-value" id="mePeriodYuan">¥0.00</span>
                                <span class="stat-label" id="meTitle">我自己</span>
                                <small class="text-muted" id="meMeta">折算 0 金币 · 贡献 0%</small>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">-1</div>
                            <div class="stat-content">
                                <span class="stat-value" id="l1PeriodYuan">¥0.00</span>
                                <span class="stat-label">一级下级</span>
                                <small class="text-muted" id="l1Meta">折算 0 金币 · 账号 0 个 · 贡献 0%</small>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">-2</div>
                            <div class="stat-content">
                                <span class="stat-value" id="l2PeriodYuan">¥0.00</span>
                                <span class="stat-label">二级下级</span>
                                <small class="text-muted" id="l2Meta">折算 0 金币 · 账号 0 个 · 贡献 0%</small>
                            </div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <div class="account-lists">
                        <details id="l1Details">
                            <summary>
                                <span id="l1SummaryTitle">一级下级账号（0）</span>
                                <span class="summary-right" id="l1SummaryRight">周期 ¥0.00 · 0 金币</span>
                            </summary>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>账号</th>
                                            <th style="width:140px;">周期收益</th>
                                            <th style="width:120px;">金币</th>
                                        </tr>
                                    </thead>
                                    <tbody id="l1TableBody">
                                        <tr><td colspan="3" class="loading-cell">加载中...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </details>

                        <details id="l2Details">
                            <summary>
                                <span id="l2SummaryTitle">二级下级账号（0）</span>
                                <span class="summary-right" id="l2SummaryRight">周期 ¥0.00 · 0 金币</span>
                            </summary>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>账号</th>
                                            <th style="width:140px;">周期收益</th>
                                            <th style="width:120px;">金币</th>
                                        </tr>
                                    </thead>
                                    <tbody id="l2TableBody">
                                        <tr><td colspan="3" class="loading-cell">加载中...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    </div>
                </div>
            </div>

            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3>近30天账号金币趋势（按账号）</h3>
                </div>
                <div class="card-body">
                    <div class="trend-legend" id="earningsTrendLegend"></div>
                    <div class="trend-chart" id="earningsTrendChart">
                        <div class="loading-placeholder">加载中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentRangeKey = '7d';
let hierarchyRequestSeq = 0;
let trendRequestSeq = 0;
let earningsTrendCache = null;
let earningsTrendSelectionInitialized = false;
let earningsTrendSelectedEnvIds = new Set();
let earningsTrendKnownEnvIds = new Set();

document.addEventListener('DOMContentLoaded', () => {
    initDefaultRange();
    bindRangeEvents();
    loadHierarchy();
});

function initDefaultRange() {
    const today = new Date();
    const start = new Date(today);
    start.setDate(start.getDate() - 6);
    setDateInputs(start, today);
    setActiveQuickRange('7d');
}

function bindRangeEvents() {
    document.getElementById('quickRanges').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-range]');
        if (!btn) return;
        applyQuickRange(btn.dataset.range);
    });

    document.getElementById('applyRange').addEventListener('click', () => {
        currentRangeKey = 'custom';
        setActiveQuickRange(null);
        loadHierarchy();
    });
}

function applyQuickRange(rangeKey) {
    const today = new Date();
    let start = new Date(today);
    let end = new Date(today);

    if (rangeKey === 'today') {
        start = today;
        end = today;
    } else if (rangeKey === 'yesterday') {
        start.setDate(start.getDate() - 1);
        end.setDate(end.getDate() - 1);
    } else if (rangeKey === '7d') {
        start.setDate(start.getDate() - 6);
    } else if (rangeKey === '30d') {
        start.setDate(start.getDate() - 29);
    } else if (rangeKey === 'all') {
        currentRangeKey = rangeKey;
        setActiveQuickRange(rangeKey);
        loadHierarchy();
        return;
    }

    currentRangeKey = rangeKey;
    setDateInputs(start, end);
    setActiveQuickRange(rangeKey);
    loadHierarchy();
}

function setActiveQuickRange(rangeKey) {
    document.querySelectorAll('#quickRanges button[data-range]').forEach(btn => {
        const isActive = rangeKey && btn.dataset.range === rangeKey;
        btn.classList.toggle('btn-primary', isActive);
        btn.classList.toggle('btn-secondary', !isActive);
    });
}

function setDateInputs(start, end) {
    document.getElementById('startDate').value = toISODate(start);
    document.getElementById('endDate').value = toISODate(end);
}

function toISODate(d) {
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

async function loadHierarchy() {
    const requestSeq = ++hierarchyRequestSeq;
    setLoadingState(true);
    try {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const url = currentRangeKey === 'all'
            ? '/stats/earnings-hierarchy?range=all'
            : `/stats/earnings-hierarchy?start_date=${encodeURIComponent(startDate)}&end_date=${encodeURIComponent(endDate)}`;
        const data = await apiRequest(url);
        if (requestSeq !== hierarchyRequestSeq) return;
        renderHierarchy(data);
        loadEarningsTrend(requestSeq);
    } catch (err) {
        console.error(err);
        showToast(err.message || '加载收益统计失败', 'error');
    } finally {
        if (requestSeq === hierarchyRequestSeq) setLoadingState(false);
    }
}

function setLoadingState(isLoading) {
    if (!isLoading) return;
    document.getElementById('l1TableBody').innerHTML = '<tr><td colspan=\"3\" class=\"loading-cell\">加载中...</td></tr>';
    document.getElementById('l2TableBody').innerHTML = '<tr><td colspan=\"3\" class=\"loading-cell\">加载中...</td></tr>';
}

function renderHierarchy(data) {
    const period = data.period || {};
    const viewer = data.viewer || {};
    const periodOverview = data.period_overview || {};
    const layers = data.layers || {};

    if (period.start_date && period.end_date) {
        document.getElementById('startDate').value = period.start_date;
        document.getElementById('endDate').value = period.end_date;
    }

    const userId = viewer.my_user_id || viewer.my_env_id || '-';
    const displayName = viewer.my_display_name || viewer.my_remark || '-';
    const envCount = Number(viewer.my_env_count || 0);
    document.getElementById('viewerInfo').textContent = `当前用户：${displayName}（user_id: ${userId} · 账号 ${envCount} 个）`;
    document.getElementById('periodRangeLabel').textContent = `周期 ${period.start_date || '-'} ~ ${period.end_date || '-'}`;
    document.getElementById('periodFormulaLabel').textContent = periodOverview.formula || '本周期总收入 = 我*100% + 一级下级*20% + 二级下级*4%';

    document.getElementById('periodTotalYuan').textContent = formatYuan(periodOverview.total_yuan);
    document.getElementById('periodTotalCoins').textContent = buildIncomeCoinsText(periodOverview.total_coins, periodOverview.gross_total_coins);

    const me = layers.me || {};
    const l1 = layers.l1 || {};
    const l2 = layers.l2 || {};

    document.getElementById('ownedTotalYuan').textContent = formatYuan(me.period_yuan);
    document.getElementById('ownedTotalCoins').textContent = `${formatCoins(me.period_coins)} 金币`;
    document.getElementById('ownedRangeLabel').textContent = `周期 ${period.start_date || '-'} ~ ${period.end_date || '-'}`;

    document.getElementById('mePeriodYuan').textContent = formatYuan(me.period_income_yuan);
    document.getElementById('meTitle').textContent = '我自己';
    document.getElementById('meMeta').textContent = buildMeMetaText(me);

    document.getElementById('l1PeriodYuan').textContent = formatYuan(l1.period_income_yuan);
    document.getElementById('l1Meta').textContent = buildLayerMetaText(l1);

    document.getElementById('l2PeriodYuan').textContent = formatYuan(l2.period_income_yuan);
    document.getElementById('l2Meta').textContent = buildLayerMetaText(l2);

    renderAccountSection('l1', l1, (data.accounts && data.accounts.l1) ? data.accounts.l1 : []);
    renderAccountSection('l2', l2, (data.accounts && data.accounts.l2) ? data.accounts.l2 : []);
}

async function loadEarningsTrend(parentSeq) {
    const expectedHierarchySeq = parentSeq || hierarchyRequestSeq;
    const requestSeq = ++trendRequestSeq;
    const container = document.getElementById('earningsTrendChart');
    const legend = document.getElementById('earningsTrendLegend');
    if (!container) return;

    if (legend) legend.innerHTML = '';
    container.innerHTML = '<div class="loading-placeholder">加载中...</div>';
    try {
        const endDate = document.getElementById('endDate')?.value;
        const url = endDate
            ? `/stats/earnings-trend-by-env?days=30&end_date=${encodeURIComponent(endDate)}`
            : '/stats/earnings-trend-by-env?days=30';
        const payload = await apiRequest(url);
        if (expectedHierarchySeq !== hierarchyRequestSeq) return;
        if (requestSeq !== trendRequestSeq) return;
        renderEarningsTrendByEnv(legend, container, payload || {});
    } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="error-placeholder">加载失败</div>';
    }
}

function trendColorForEnvId(envId) {
    const hue = (Number(envId || 0) * 47) % 360;
    return `hsl(${hue}, 70%, 50%)`;
}

function trendLevelPrefix(level) {
    if (level === 'me') return '我: ';
    if (level === 'l1') return '-1: ';
    if (level === 'l2') return '-2: ';
    return '';
}

function renderEarningsTrendChart() {
    const chartContainer = document.getElementById('earningsTrendChart');
    if (!chartContainer) return;

    if (!earningsTrendCache || !Array.isArray(earningsTrendCache.dates) || !Array.isArray(earningsTrendCache.accounts)) {
        chartContainer.innerHTML = '<div class="empty-placeholder">暂无数据</div>';
        return;
    }

    const dates = earningsTrendCache.dates;
    const accounts = earningsTrendCache.accounts;
    const n = dates.length;

    const visibleAccounts = accounts.filter(a => earningsTrendSelectedEnvIds.has(String(a.env_id)));
    if (!visibleAccounts.length) {
        chartContainer.innerHTML = '<div class="empty-placeholder">请选择要展示的账号</div>';
        return;
    }

    const maxValue = Math.max(
        ...visibleAccounts.flatMap(a => (Array.isArray(a.coins) ? a.coins : []).map(x => Number(x || 0)))
    );
    if (!isFinite(maxValue) || maxValue <= 0) {
        chartContainer.innerHTML = '<div class="empty-placeholder">暂无数据</div>';
        return;
    }

    const width = 720;
    const height = 260;
    const padding = { left: 46, right: 14, top: 12, bottom: 32 };
    const plotW = width - padding.left - padding.right;
    const plotH = height - padding.top - padding.bottom;
    const xFor = (i) => (n === 1 ? padding.left + plotW / 2 : padding.left + (i / (n - 1)) * plotW);
    const yFor = (v) => padding.top + (1 - (v / maxValue)) * plotH;

    const gridLines = 4;
    const gridSvg = Array.from({ length: gridLines + 1 }, (_, idx) => {
        const t = idx / gridLines;
        const y = padding.top + t * plotH;
        const value = Math.round(maxValue * (1 - t));
        const label = formatTrendTick(value);
        return `
            <g>
                <line x1="${padding.left}" y1="${y}" x2="${padding.left + plotW}" y2="${y}" style="stroke: var(--border-color); stroke-opacity: 0.6; stroke-width: 1;" />
                <text x="${padding.left - 8}" y="${y + 4}" text-anchor="end" style="fill: var(--text-muted); font-size: 10px;">${label}</text>
            </g>
        `;
    }).join('');

    const xLabelIndexes = new Set([0, n - 1]);
    const labelCount = 6;
    const step = Math.max(1, Math.round((n - 1) / (labelCount - 1)));
    for (let i = 0; i < n; i += step) xLabelIndexes.add(i);

    const xLabelsSvg = Array.from(xLabelIndexes)
        .sort((a, b) => a - b)
        .map(i => {
            const d = dates[i] || '';
            const label = d ? d.substring(5) : '';
            const x = xFor(i);
            const y = height - 10;
            return `<text x="${x}" y="${y}" text-anchor="middle" style="fill: var(--text-muted); font-size: 10px;">${label}</text>`;
        })
        .join('');

    // 生成数据点高亮圆圈
    const highlightPointsSvg = visibleAccounts.map(a => {
        const envId = String(a.env_id);
        const color = trendColorForEnvId(envId);
        const coins = Array.isArray(a.coins) ? a.coins.map(x => Number(x || 0)) : [];
        return Array.from({ length: n }, (_, i) => {
            const v = Number(coins[i] || 0);
            const cx = xFor(i);
            const cy = yFor(v);
            return `<circle class="chart-point-highlight" data-env-id="${envId}" data-index="${i}"
                cx="${cx}" cy="${cy}" r="4" fill="${color}" stroke="${color}" />`;
        }).join('');
    }).join('');

    // 生成交互层（透明矩形用于捕获鼠标事件）
    const hoverAreasSvg = Array.from({ length: n }, (_, i) => {
        let xStart, xEnd;
        if (n === 1) {
            xStart = padding.left;
            xEnd = padding.left + plotW;
        } else {
            const halfStep = plotW / (n - 1) / 2;
            xStart = Math.max(padding.left, xFor(i) - halfStep);
            xEnd = Math.min(padding.left + plotW, xFor(i) + halfStep);
        }
        const width = xEnd - xStart;
        return `<rect class="chart-hover-area" data-index="${i}"
            x="${xStart}" y="${padding.top}" width="${width}" height="${plotH}"
            fill="transparent" style="cursor: crosshair;" />`;
    }).join('');

    // 垂直指示线
    const cursorLine = `<line class="chart-cursor-line" id="chartCursorLine"
        x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${padding.top + plotH}" />`;

    const seriesSvg = visibleAccounts.map(a => {
        const envId = String(a.env_id);
        const color = trendColorForEnvId(envId);
        const coins = Array.isArray(a.coins) ? a.coins.map(x => Number(x || 0)) : [];
        const padded = Array.from({ length: n }, (_, i) => Number(coins[i] || 0));
        const points = padded.map((v, i) => `${xFor(i)},${yFor(v)}`).join(' ');
        return `
            <g>
                <polyline fill="none" points="${points}" style="stroke: ${color}; stroke-width: 2; stroke-opacity: 0.85;" vector-effect="non-scaling-stroke" />
            </g>
        `;
    }).join('');

    chartContainer.innerHTML = `
        <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none" class="trend-svg" role="img" aria-label="近30天账号金币趋势">
            ${gridSvg}
            ${seriesSvg}
            ${highlightPointsSvg}
            ${cursorLine}
            ${hoverAreasSvg}
            ${xLabelsSvg}
        </svg>
        <div class="chart-tooltip" id="chartTooltip"></div>
    `;

    // 绑定悬停事件
    setupChartHoverEvents(chartContainer, dates, visibleAccounts, xFor, yFor, padding, plotH, width);
}

/**
 * 设置折线图悬停事件
 */
function setupChartHoverEvents(chartContainer, dates, visibleAccounts, xFor, yFor, padding, plotH, width) {
    const svg = chartContainer.querySelector('.trend-svg');
    const tooltip = chartContainer.querySelector('#chartTooltip');
    const cursorLine = chartContainer.querySelector('#chartCursorLine');
    const highlightPoints = chartContainer.querySelectorAll('.chart-point-highlight');
    const hoverAreas = chartContainer.querySelectorAll('.chart-hover-area');

    if (!svg || !tooltip || !cursorLine) return;

    // 隐藏提示框
    const hideTooltip = () => {
        tooltip.classList.remove('visible');
        cursorLine.classList.remove('visible');
        highlightPoints.forEach(p => p.classList.remove('visible'));
    };

    // 显示提示框
    const showTooltip = (index, clientX, clientY) => {
        const date = dates[index];
        if (!date) return;

        // 构建提示内容，按金币数量从高到低排序
        const accountItems = visibleAccounts
            .map(a => {
                const envId = String(a.env_id);
                const color = trendColorForEnvId(envId);
                const coins = Array.isArray(a.coins) ? a.coins.map(x => Number(x || 0)) : [];
                const value = Number(coins[index] || 0);
                const remark = (a.remark || '').trim() || ('账号#' + a.env_id);
                const label = `${trendLevelPrefix(a.level)}${remark}`;
                return { account: a, color, value, label };
            })
            .sort((a, b) => b.value - a.value);  // 按金币从高到低排序

        const itemsHtml = accountItems
            .map(item => `
                <div class="chart-tooltip-item">
                    <span class="tooltip-dot" style="background: ${item.color};"></span>
                    <span class="tooltip-label" title="${escapeHtml(item.label)}">${escapeHtml(item.label)}</span>
                    <span class="tooltip-value">${formatCoins(item.value)}</span>
                </div>
            `)
            .join('');

        tooltip.innerHTML = `
            <div class="chart-tooltip-date">${date}</div>
            ${itemsHtml}
        `;

        // 先设置为可见以获取尺寸
        tooltip.classList.add('visible');
        const tooltipRect = tooltip.getBoundingClientRect();

        // 使用 fixed 定位，坐标基于 viewport
        let tooltipX = clientX + 12;
        let tooltipY = clientY - 10;

        // 防止溢出右边界
        if (tooltipX + tooltipRect.width > window.innerWidth) {
            tooltipX = clientX - tooltipRect.width - 12;
        }

        // 防止溢出上边界
        if (tooltipY < 10) {
            tooltipY = 10;
        }
        // 防止溢出下边界
        if (tooltipY + tooltipRect.height > window.innerHeight) {
            tooltipY = window.innerHeight - tooltipRect.height - 10;
        }

        tooltip.style.left = `${tooltipX}px`;
        tooltip.style.top = `${tooltipY}px`;

        // 更新指示线位置
        const xPos = xFor(index);
        cursorLine.setAttribute('x1', xPos);
        cursorLine.setAttribute('x2', xPos);
        cursorLine.classList.add('visible');

        // 高亮当前数据点
        highlightPoints.forEach(p => {
            if (parseInt(p.dataset.index) === index) {
                p.classList.add('visible');
            } else {
                p.classList.remove('visible');
            }
        });
    };

    // 为每个悬停区域绑定事件
    hoverAreas.forEach((area, i) => {
        const index = parseInt(area.dataset.index);

        area.addEventListener('mouseenter', (e) => {
            showTooltip(index, e.clientX, e.clientY);
        });

        area.addEventListener('mousemove', (e) => {
            // 使用 fixed 定位，直接基于 viewport 坐标
            const tooltipRect = tooltip.getBoundingClientRect();
            let tooltipX = e.clientX + 12;
            let tooltipY = e.clientY - 10;

            // 防止溢出右边界
            if (tooltipX + tooltipRect.width > window.innerWidth) {
                tooltipX = e.clientX - tooltipRect.width - 12;
            }

            // 防止溢出上边界
            if (tooltipY < 10) {
                tooltipY = 10;
            }
            // 防止溢出下边界
            if (tooltipY + tooltipRect.height > window.innerHeight) {
                tooltipY = window.innerHeight - tooltipRect.height - 10;
            }

            tooltip.style.left = `${tooltipX}px`;
            tooltip.style.top = `${tooltipY}px`;
        });

        area.addEventListener('mouseleave', () => {
            hideTooltip();
        });
    });

    // 鼠标离开整个图表区域时隐藏提示
    svg.addEventListener('mouseleave', hideTooltip);
}

function renderEarningsTrendByEnv(legend, container, payload) {
    const dates = Array.isArray(payload.dates) ? payload.dates : [];
    const rows = Array.isArray(payload.accounts) ? payload.accounts : [];

    if (!dates.length || !rows.length) {
        if (legend) legend.innerHTML = '';
        container.innerHTML = '<div class="empty-placeholder">暂无数据</div>';
        earningsTrendCache = null;
        return;
    }

    const levelOrder = { me: 0, l1: 1, l2: 2, unknown: 3 };
    const accounts = rows.slice().sort((a, b) => {
        const ao = levelOrder[a.level] ?? 9;
        const bo = levelOrder[b.level] ?? 9;
        if (ao !== bo) return ao - bo;
        return Number(b.total_coins || 0) - Number(a.total_coins || 0);
    });

    earningsTrendCache = { dates, accounts };

    const availableEnvIds = new Set(accounts.map(a => String(a.env_id)));
    if (!earningsTrendSelectionInitialized) {
        earningsTrendSelectedEnvIds = new Set(Array.from(availableEnvIds));
        earningsTrendKnownEnvIds = new Set(Array.from(availableEnvIds));
        earningsTrendSelectionInitialized = true;
    } else {
        Array.from(earningsTrendSelectedEnvIds).forEach(envId => {
            if (!availableEnvIds.has(envId)) earningsTrendSelectedEnvIds.delete(envId);
        });
        availableEnvIds.forEach(envId => {
            if (!earningsTrendKnownEnvIds.has(envId)) earningsTrendSelectedEnvIds.add(envId);
        });
        earningsTrendKnownEnvIds = new Set(Array.from(availableEnvIds));
    }

    if (legend) {
        legend.innerHTML = accounts
            .map(a => {
                const envId = String(a.env_id);
                const color = trendColorForEnvId(envId);
                const checked = earningsTrendSelectedEnvIds.has(envId) ? 'checked' : '';
                const remark = (a.remark || '').trim() || ('账号#' + a.env_id);
                const label = `${trendLevelPrefix(a.level)}${remark}`;
                return `
                    <label class="trend-check">
                        <input class="trend-check-input" type="checkbox" data-env-id="${envId}" ${checked} />
                        <span class="legend-dot" style="background:${color}"></span>
                        <span class="trend-check-label">${escapeHtml(label)}</span>
                    </label>
                `;
            })
            .join('');

        if (!legend.dataset.bound) {
            legend.addEventListener('change', (e) => {
                const target = e.target;
                if (!target || target.tagName !== 'INPUT') return;
                const envId = target.dataset.envId;
                if (!envId) return;
                if (target.checked) {
                    earningsTrendSelectedEnvIds.add(envId);
                } else {
                    earningsTrendSelectedEnvIds.delete(envId);
                }
                renderEarningsTrendChart();
            });
            legend.dataset.bound = '1';
        }
    }

    renderEarningsTrendChart();
}

function renderAccountSection(levelKey, layer, rows) {
    const cnt = layer.count || 0;
    const periodYuan = formatYuan(layer.period_yuan);
    const periodCoins = Number(layer.period_coins || 0);

    document.getElementById(`${levelKey}SummaryTitle`).textContent = `${levelKey === 'l1' ? '一级下级账号' : '二级下级账号'}（${cnt}）`;
    document.getElementById(`${levelKey}SummaryRight`).textContent = `周期 ${periodYuan} · ${formatCoins(periodCoins)} 金币`;

    const tbody = document.getElementById(`${levelKey}TableBody`);
    if (!rows || rows.length === 0) {
        tbody.innerHTML = '<tr><td colspan=\"3\" class=\"empty-cell\">暂无账号</td></tr>';
        return;
    }

    tbody.innerHTML = rows.map(r => {
        const coins = Number(r.period_coins || 0);
        return `
            <tr>
                <td>${escapeHtml(r.remark || ('账号#' + r.env_id))}</td>
                <td class=\"coins-total\">${formatYuan(r.period_yuan)}</td>
                <td>${formatCoins(coins)} 金币</td>
            </tr>
        `;
    }).join('');
}

function buildMeMetaText(layer) {
    const share = formatPct(layer.share_pct);
    const incomeCoins = Number(layer.period_income_coins || 0);
    const grossCoins = Number(layer.period_coins || 0);
    return `折算 ${formatCoins(incomeCoins)} 金币（原始 ${formatCoins(grossCoins)} 金币）· 贡献 ${share}%`;
}

function buildLayerMetaText(layer) {
    const cnt = layer.count || 0;
    const share = formatPct(layer.share_pct);
    const incomeCoins = Number(layer.period_income_coins || 0);
    const grossCoins = Number(layer.period_coins || 0);
    return `折算 ${formatCoins(incomeCoins)} 金币（原始 ${formatCoins(grossCoins)} 金币）· 账号 ${cnt} 个 · 贡献 ${share}%`;
}

function buildIncomeCoinsText(incomeCoins, grossCoins) {
    const income = Number(incomeCoins || 0);
    const gross = Number(grossCoins || 0);
    const base = `折算 ${formatCoins(income)} 金币`;
    if (!gross) return base;
    return `${base}（原始 ${formatCoins(gross)} 金币）`;
}

function formatTrendTick(value) {
    const num = Number(value || 0);
    if (num >= 10000) return (num / 10000).toFixed(1) + '万';
    return String(Math.round(num));
}

function formatCoins(value) {
    const num = Number(value || 0);
    return num.toLocaleString('zh-CN');
}

function formatYuan(value) {
    const num = Number(value || 0);
    return '¥' + num.toFixed(2);
}

function formatPct(value) {
    const num = Number(value || 0);
    return num.toFixed(2);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text == null ? '' : String(text);
    return div.innerHTML;
}
</script>

<style>
.filter-right {
    flex: 1;
    justify-content: flex-end;
}
.account-lists details {
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--card-bg);
    margin-bottom: 12px;
    overflow: hidden;
}
.account-lists summary {
    cursor: pointer;
    padding: 12px 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    font-weight: 600;
    list-style: none;
}
.account-lists summary::-webkit-details-marker {
    display: none;
}
.account-lists details[open] summary {
    border-bottom: 1px solid var(--border-color);
}
.account-lists .summary-right {
    color: var(--text-muted);
    font-weight: 400;
}
.account-lists details .table-responsive {
    padding: 10px 14px 14px;
}
.stat-card .stat-content small {
    font-size: 12px;
}

.trend-legend {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 10px;
    color: var(--text-muted);
    font-size: 13px;
    max-height: 96px;
    overflow-y: auto;
    padding: 4px 0;
}

.trend-check {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    user-select: none;
}

.trend-check-input {
    margin: 0;
}

.trend-check-input:checked + .legend-dot + .trend-check-label {
    color: var(--text-color);
}

.trend-legend .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}

.trend-chart {
    width: 100%;
    height: 260px;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    background: var(--bg-color);
    overflow: hidden;
    position: relative;
}

.trend-chart .trend-svg {
    width: 100%;
    height: 100%;
    display: block;
}

/* 折线图悬停提示 */
.chart-tooltip {
    position: fixed;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    border-radius: 8px;
    padding: 10px 12px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s ease;
    z-index: 99999;
    min-width: 140px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.chart-tooltip.visible {
    opacity: 1;
}

.chart-tooltip-date {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 6px;
    padding-bottom: 6px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
}

.chart-tooltip-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    font-size: 12px;
    color: #fff;
    padding: 3px 0;
}

.chart-tooltip-item .tooltip-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.chart-tooltip-item .tooltip-label {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100px;
}

.chart-tooltip-item .tooltip-value {
    font-weight: 600;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
}

/* 悬停指示线 */
.chart-cursor-line {
    stroke: var(--border-color);
    stroke-width: 1;
    stroke-dasharray: 4 4;
    opacity: 0;
    transition: opacity 0.1s;
}

.chart-cursor-line.visible {
    opacity: 1;
}

/* 数据点高亮 */
.chart-point-highlight {
    fill: var(--card-bg, #fff);
    stroke-width: 2;
    opacity: 0;
    transition: opacity 0.1s;
}

.chart-point-highlight.visible {
    opacity: 1;
}
</style>
{% endblock %}
