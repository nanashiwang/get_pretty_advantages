{% extends "base.html" %}

{% block title %}ç»“ç®—ä¸­å¿ƒ - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}ç»“ç®—ä¸­å¿ƒ{% endblock %}

{% block content %}
<!-- æœ¬æœŸç»“ç®—æ¦‚è§ˆ -->
<div class="settlement-header-card">
    <div class="settlement-header-info">
        <div class="settlement-header-title">
            <span class="settlement-icon">ğŸ“Š</span>
            <div>
                <h3>æœ¬æœŸç»“ç®—</h3>
                <p class="settlement-subtitle">å½“å‰ç»“ç®—æœŸä¿¡æ¯</p>
            </div>
        </div>
        <div class="settlement-meta-tags">
            <span class="meta-tag">
                <span class="meta-icon">ğŸ“…</span>
                ç»Ÿè®¡å‘¨æœŸï¼š<strong id="settlementPeriodRange">-</strong>
            </span>
            <span class="meta-tag">
                <span class="meta-icon">â°</span>
                ç¼´è´¹çª—å£ï¼š<strong id="settlementPayRange">-</strong>
            </span>
            <span class="meta-tag">
                <span class="meta-icon">ğŸ’±</span>
                å…‘ç‡ï¼š<strong id="settlementCoinRate">10000</strong> coins = 1 å…ƒ
            </span>
        </div>
    </div>
    <button class="btn-refresh" onclick="loadSettlementCenter()">
        <span>ğŸ”„</span> åˆ·æ–°
    </button>
</div>

<div id="settlementEmpty" class="empty-state" style="display:none;">
    <span class="empty-icon">ğŸ“­</span>
    <p>å½“å‰æš‚æ— ç»“ç®—æœŸ</p>
</div>

<div id="settlementContent" style="display:none;">
    <!-- æ”¶ç›Šç»Ÿè®¡å¡ç‰‡ -->
    <div class="settlement-stats-grid">
        <div class="settlement-stat-card settlement-stat-gross">
            <div class="stat-icon-bg">ğŸ’°</div>
            <div class="stat-content">
                <span class="stat-value" id="settlementGrossYuan">ï¿¥0.00</span>
                <span class="stat-label">æœ¬æœŸæ€»æ”¶ç›Š</span>
                <span class="stat-sub" id="settlementGrossCoins">0 coins</span>
            </div>
        </div>
        <div class="settlement-stat-card settlement-stat-due">
            <div class="stat-icon-bg">ğŸ“¤</div>
            <div class="stat-content">
                <span class="stat-value" id="settlementDueYuan">ï¿¥0.00</span>
                <span class="stat-label">æœ¬æœŸåº”ç¼´</span>
                <span class="stat-sub" id="settlementDueCoins">0 coins</span>
            </div>
        </div>
        <div class="settlement-stat-card settlement-stat-paid">
            <div class="stat-icon-bg">âœ…</div>
            <div class="stat-content">
                <span class="stat-value" id="settlementPaidYuan">ï¿¥0.00</span>
                <span class="stat-label">å·²ç¼´é‡‘é¢</span>
                <span class="stat-sub" id="settlementPaidCoins">0 coins</span>
            </div>
        </div>
        <div class="settlement-stat-card settlement-stat-status">
            <div class="stat-icon-bg">ğŸ“‹</div>
            <div class="stat-content">
                <span class="stat-value" id="settlementStatusText">-</span>
                <span class="stat-label">ç¼´è´¹çŠ¶æ€</span>
                <span class="stat-sub" id="settlementStatusBadge">-</span>
            </div>
        </div>
    </div>
</div>

<!-- æäº¤ç¼´è´¹è¡¨å• -->
<div class="settlement-form-card" id="settlementPayFormCard" style="display:none;">
    <div class="settlement-form-header">
        <h3>ğŸ’³ æäº¤ç¼´è´¹</h3>
        <button class="btn-submit" onclick="submitSettlementPayment()">æäº¤ç¼´è´¹</button>
    </div>
    <div class="settlement-form-body">
        <div class="settlement-form-grid">
            <div class="settlement-form-group">
                <label>ç¼´è´¹é‡‘é¢ï¼ˆcoinsï¼‰<span class="required">*</span></label>
                <input type="number" id="paymentAmountCoins" min="1" step="1" placeholder="è¯·è¾“å…¥æœ¬æ¬¡ç¼´è´¹é‡‘å¸æ•°">
                <span class="input-hint">ç³»ç»Ÿå°†ä»¥ coins è®°è´¦ï¼›å±•ç¤ºæ—¶æŒ‰æœ¬æœŸå…‘ç‡æ¢ç®—äººæ°‘å¸</span>
            </div>
            <div class="settlement-form-group">
                <label>ç¼´è´¹æ–¹å¼</label>
                <select id="paymentMethod">
                    <option value="manual">ğŸ”„ äººå·¥è½¬è´¦</option>
                    <option value="alipay">ğŸ’™ æ”¯ä»˜å®</option>
                    <option value="wechat">ğŸ’š å¾®ä¿¡æ”¯ä»˜</option>
                    <option value="bank">ğŸ¦ é“¶è¡Œå¡</option>
                </select>
                <!-- æ”¯ä»˜å®æ”¶æ¬¾ç  -->
                <div class="payment-method-qrcode" id="alipayQrcodeBox" style="display:none;">
                    <div class="payment-method-qrcode-wrapper">
                        <img id="alipayQrcodeImage" src="/data/uploads/æ”¶æ¬¾ç /æ”¯ä»˜å®æ”¶æ¬¾ç .jpg" alt="æ”¯ä»˜å®æ”¶æ¬¾ç " onerror="this.style.display='none';document.getElementById('alipayQrcodeFallback').style.display='block';" />
                        <div class="payment-method-qrcode-fallback" id="alipayQrcodeFallback" style="display:none;">
                            <p class="fallback-title">æœªé…ç½®æ”¯ä»˜å®æ”¶æ¬¾ç </p>
                            <p class="fallback-hint">è¯·è”ç³»ç®¡ç†å‘˜è®¾ç½®æ”¶æ¬¾ç </p>
                        </div>
                    </div>
                    <div class="payment-method-qrcode-hint">
                        ä½¿ç”¨æ”¯ä»˜å®æ‰«ç å®Œæˆè½¬è´¦åï¼Œè¯·å¡«å†™å‡­è¯é“¾æ¥å¹¶æäº¤ç¼´è´¹ã€‚
                    </div>
                </div>
                <!-- å¾®ä¿¡æ”¶æ¬¾ç  -->
                <div class="payment-method-qrcode" id="wechatQrcodeBox" style="display:none;">
                    <div class="payment-method-qrcode-wrapper">
                        <img id="wechatQrcodeImage" src="/data/uploads/æ”¶æ¬¾ç /å¾®ä¿¡æ”¶æ¬¾ç .jpg" alt="å¾®ä¿¡æ”¶æ¬¾ç " onerror="this.style.display='none';document.getElementById('wechatQrcodeFallback').style.display='block';" />
                        <div class="payment-method-qrcode-fallback" id="wechatQrcodeFallback" style="display:none;">
                            <p class="fallback-title">æœªé…ç½®å¾®ä¿¡æ”¶æ¬¾ç </p>
                            <p class="fallback-hint">è¯·è”ç³»ç®¡ç†å‘˜è®¾ç½®æ”¶æ¬¾ç </p>
                        </div>
                    </div>
                    <div class="payment-method-qrcode-hint">
                        ä½¿ç”¨å¾®ä¿¡æ‰«ç å®Œæˆè½¬è´¦åï¼Œè¯·å¡«å†™å‡­è¯é“¾æ¥å¹¶æäº¤ç¼´è´¹ã€‚
                    </div>
                </div>
            </div>
        </div>
        <div class="settlement-form-group">
            <label>å‡­è¯é“¾æ¥ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="paymentProofUrl" maxlength="512" placeholder="å¦‚æœ‰ï¼Œå¯å¡«å†™æˆªå›¾/äº‘ç›˜é“¾æ¥ç­‰">
        </div>
        <div class="settlement-form-hint" id="paymentHint"></div>
    </div>
</div>

<!-- å°å·ææŠ¥ -->
<div class="settlement-form-card" id="banReportFormCard" style="display:none;">
    <div class="settlement-form-header">
        <h3>ğŸš« å°å·ææŠ¥</h3>
        <button class="btn-submit" onclick="submitBanReport()">æäº¤ææŠ¥</button>
    </div>
    <div class="settlement-form-body">
        <div class="settlement-form-grid">
            <div class="settlement-form-group">
                <label>è¢«å°ç¦é‡‘é¢ï¼ˆcoinsï¼‰<span class="required">*</span></label>
                <input type="number" id="banBannedCoins" min="1" step="1" placeholder="è¯·è¾“å…¥è¢«å°ç¦çš„é‡‘å¸æ•°">
                <span class="input-hint" id="banDeductHint">å®¡æ ¸é€šè¿‡åæŒ‰æœ¬æœŸè§„åˆ™æ‰£å‡åº”ç¼´ä¸åˆ†æˆ</span>
            </div>
            <div class="settlement-form-group">
                <label>æˆªå›¾ï¼ˆå¿…å¡«ï¼‰<span class="required">*</span></label>
                <input type="file" id="banProofFile" accept="image/png,image/jpeg,image/jpg,image/gif,image/webp">
                <span class="input-hint">ä»…æ”¯æŒ png/jpg/jpeg/gif/webpï¼›æˆªå›¾å°†ä¿å­˜åˆ°æœåŠ¡å™¨ data/uploads/ban_reports/</span>
            </div>
        </div>
        <div class="settlement-form-hint">
            ğŸ’¡ å£å¾„ï¼šåº”ç”¨åä¼šå¯¹æœ¬æœŸè¯¥ç”¨æˆ·ç»“ç®—æ±‡æ€»é‡æ–°è®¡ç®—ï¼ˆgross / åº”ç¼´ / +1 / +2 / å¹³å°ç•™å­˜ï¼‰ï¼Œå¹¶åŒæ­¥æ›´æ–°åº”ç¼´çŠ¶æ€ï¼›è‹¥åˆ†æˆå·²èµ„é‡‘åŒ–å…¥è´¦ï¼Œåˆ™ç¦æ­¢åº”ç”¨ã€‚
        </div>
        <div class="settlement-form-hint" id="banReportHint"></div>
    </div>
</div>

<!-- å°å·ææŠ¥è®°å½• -->
<div class="settlement-table-card" id="banReportTableCard" style="display:none;">
    <div class="settlement-table-header">
        <h3>ğŸ“Œ å°å·ææŠ¥è®°å½•</h3>
    </div>
    <div class="table-responsive">
        <table class="settlement-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>æäº¤æ—¶é—´</th>
                    <th>è¢«å°ç¦</th>
                    <th>çŠ¶æ€</th>
                    <th>æ˜¯å¦å·²åº”ç”¨</th>
                    <th>æˆªå›¾</th>
                    <th>æ‰£å‡æ¦‚è§ˆ</th>
                    <th>å®¡æ ¸æ—¶é—´</th>
                    <th>é©³å›åŸå› </th>
                </tr>
            </thead>
            <tbody id="banReportTableBody">
                <tr><td colspan="9" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ç¼´è´¹è®°å½•è¡¨æ ¼ -->
<div class="settlement-table-card">
    <div class="settlement-table-header">
        <h3>ğŸ“œ ç¼´è´¹è®°å½•</h3>
    </div>
    <div class="table-responsive">
        <table class="settlement-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>æäº¤æ—¶é—´</th>
                    <th>é‡‘é¢</th>
                    <th>æ–¹å¼</th>
                    <th>çŠ¶æ€</th>
                    <th>å‡­è¯</th>
                    <th>å®¡æ ¸æ—¶é—´</th>
                    <th>é©³å›åŸå› </th>
                </tr>
            </thead>
            <tbody id="paymentTableBody">
                <tr><td colspan="8" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<style>
/* ç»“ç®—ä¸­å¿ƒæ•´ä½“æ ·å¼ */
.settlement-header-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.25);
}

.settlement-header-info {
    flex: 1;
}

.settlement-header-title {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}

.settlement-icon {
    font-size: 48px;
    background: rgba(255,255,255,0.2);
    width: 72px;
    height: 72px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.settlement-header-title h3 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
    color: white;
}

.settlement-subtitle {
    margin: 4px 0 0 0;
    font-size: 14px;
    color: rgba(255,255,255,0.8);
}

.settlement-meta-tags {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.meta-tag {
    background: rgba(255,255,255,0.15);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    color: white;
    display: flex;
    align-items: center;
    gap: 6px;
    backdrop-filter: blur(10px);
}

.meta-icon {
    font-size: 14px;
}

.meta-tag strong {
    font-weight: 600;
}

.btn-refresh {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
}

.btn-refresh:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-1px);
}

.btn-refresh:active {
    transform: translateY(0);
}

/* ç©ºçŠ¶æ€ */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    background: var(--bg-color);
    border-radius: 16px;
    border: 1px dashed var(--border-color);
}

.empty-icon {
    font-size: 64px;
    display: block;
    margin-bottom: 16px;
}

.empty-state p {
    font-size: 16px;
    color: var(--text-muted);
    margin: 0;
}

/* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
.settlement-stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 24px;
}

.settlement-stat-card {
    background: var(--bg-color);
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    border: 1px solid var(--border-color);
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
}

.settlement-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.settlement-stat-gross::before {
    background: linear-gradient(90deg, #10b981, #34d399);
}

.settlement-stat-due::before {
    background: linear-gradient(90deg, #f59e0b, #fbbf24);
}

.settlement-stat-paid::before {
    background: linear-gradient(90deg, #3b82f6, #60a5fa);
}

.settlement-stat-status::before {
    background: linear-gradient(90deg, #8b5cf6, #a78bfa);
}

.settlement-stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.stat-icon-bg {
    font-size: 36px;
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.settlement-stat-gross .stat-icon-bg {
    background: linear-gradient(135deg, #d1fae5, #a7f3d0);
}

.settlement-stat-due .stat-icon-bg {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
}

.settlement-stat-paid .stat-icon-bg {
    background: linear-gradient(135deg, #dbeafe, #bfdbfe);
}

.settlement-stat-status .stat-icon-bg {
    background: linear-gradient(135deg, #ede9fe, #ddd6fe);
}

.settlement-stat-card .stat-content {
    display: flex;
    flex-direction: column;
}

.settlement-stat-card .stat-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-color);
    line-height: 1.2;
}

.settlement-stat-card .stat-label {
    font-size: 13px;
    color: var(--text-muted);
    margin: 4px 0;
}

.settlement-stat-card .stat-sub {
    font-size: 12px;
    color: var(--text-muted);
}

/* è¡¨å•å¡ç‰‡ */
.settlement-form-card {
    background: var(--bg-color);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    margin-bottom: 24px;
    overflow: hidden;
}

.settlement-form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0,0,0,0.02);
}

.settlement-form-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.btn-submit {
    background: linear-gradient(135deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 10px 24px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.settlement-form-body {
    padding: 24px;
}

.settlement-form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

.settlement-form-group {
    display: flex;
    flex-direction: column;
}

.settlement-form-group label {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-color);
    margin-bottom: 8px;
}

.settlement-form-group .required {
    color: #ef4444;
}

.settlement-form-group input,
.settlement-form-group select {
    padding: 12px 16px;
    border: 1px solid var(--border-color);
    border-radius: 10px;
    font-size: 14px;
    background: var(--bg-color);
    transition: all 0.2s;
}

.settlement-form-group input:focus,
.settlement-form-group select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.input-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
}

.payment-method-qrcode {
    margin-top: 12px;
    padding: 12px;
    border-radius: 12px;
    border: 1px dashed rgba(102, 126, 234, 0.35);
    background: rgba(102, 126, 234, 0.06);
}

.payment-method-qrcode-wrapper {
    display: flex;
    justify-content: center;
}

.payment-method-qrcode img {
    width: 180px;
    height: 180px;
    object-fit: contain;
    border-radius: 12px;
    background: #fff;
    padding: 8px;
    border: 1px solid var(--border-color);
}

.payment-method-qrcode-fallback {
    text-align: center;
    color: var(--text-muted);
}

.payment-method-qrcode-fallback .fallback-title {
    margin: 0;
    font-weight: 600;
    color: var(--text-color);
}

.payment-method-qrcode-fallback .fallback-hint {
    margin: 6px 0 0 0;
    font-size: 12px;
}

.payment-method-qrcode-hint {
    margin-top: 10px;
    font-size: 12px;
    color: var(--text-muted);
    text-align: center;
}

.settlement-form-hint {
    padding: 12px 16px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 10px;
    font-size: 14px;
    color: #667eea;
}

/* è¡¨æ ¼å¡ç‰‡ */
.settlement-table-card {
    background: var(--bg-color);
    border-radius: 16px;
    border: 1px solid var(--border-color);
    overflow: hidden;
}

.settlement-table-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0,0,0,0.02);
}

.settlement-table-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
}

.settlement-table {
    width: 100%;
    border-collapse: collapse;
}

.settlement-table thead th {
    text-align: left;
    padding: 14px 20px;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border-color);
    background: rgba(0,0,0,0.02);
}

.settlement-table tbody td {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
}

.settlement-table tbody tr:last-child td {
    border-bottom: none;
}

.settlement-table tbody tr:hover {
    background: rgba(0,0,0,0.02);
}

.loading-cell, .empty-cell, .error-cell {
    text-align: center !important;
    padding: 40px 20px !important;
    color: var(--text-muted);
}

/* çŠ¶æ€å¾½ç«  */
.status-badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-pending {
    background: #fef3c7;
    color: #92400e;
}

.status-paid {
    background: #d1fae5;
    color: #065f46;
}

.status-invalid, .status-rejected {
    background: #fee2e2;
    color: #991b1b;
}

.status-open {
    background: #dbeafe;
    color: #1e40af;
}

.status-closed {
    background: #e5e7eb;
    color: #374151;
}

/* å“åº”å¼é€‚é… */
@media (max-width: 1200px) {
    .settlement-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .settlement-header-card {
        flex-direction: column;
        gap: 16px;
    }

    .settlement-header-title {
        flex-direction: column;
        text-align: center;
    }

    .settlement-meta-tags {
        justify-content: center;
    }

    .btn-refresh {
        width: 100%;
        justify-content: center;
    }

    .settlement-stats-grid {
        grid-template-columns: 1fr;
    }

    .settlement-form-grid {
        grid-template-columns: 1fr;
    }

    .settlement-form-header {
        flex-direction: column;
        gap: 12px;
    }

    .btn-submit {
        width: 100%;
    }

    .settlement-table {
        font-size: 12px;
    }

    .settlement-table thead th,
    .settlement-table tbody td {
        padding: 10px 12px;
    }
}
</style>

<script>
let currentPeriodId = null;
let currentCoinRate = 10000;
let currentDueCoins = 0;
let currentPaidCoins = 0;
let currentPayWindow = null;
let currentAlipayQrcodeUrl = null;
let currentWechatQrcodeUrl = null;
let currentCollectBps = 4000;
let currentL1Bps = 2000;
let currentL2Bps = 400;

function coinsToYuan(coins) {
    const rate = currentCoinRate > 0 ? currentCoinRate : 10000;
    return (Number(coins || 0) / rate).toFixed(2);
}

function readToken() {
    return localStorage.getItem('access_token');
}

async function apiRequestForm(url, formData) {
    const token = readToken();
    const headers = {};
    if (token) headers['Authorization'] = `Bearer ${token}`;

    const resp = await fetch(`/api${url}`, { method: 'POST', headers, body: formData });
    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
        if (resp.status === 401) {
            localStorage.removeItem('access_token');
            localStorage.removeItem('current_user');
            window.location.href = '/login';
            return;
        }
        throw new Error(data.detail || data.message || `è¯·æ±‚å¤±è´¥: ${resp.status}`);
    }
    return data;
}

function updatePaymentMethodQrcode() {
    const methodEl = document.getElementById('paymentMethod');
    const alipayBox = document.getElementById('alipayQrcodeBox');
    const wechatBox = document.getElementById('wechatQrcodeBox');
    if (!methodEl) return;

    // éšè—æ‰€æœ‰äºŒç»´ç 
    if (alipayBox) alipayBox.style.display = 'none';
    if (wechatBox) wechatBox.style.display = 'none';

    const method = methodEl.value;

    // æ˜¾ç¤ºæ”¯ä»˜å®æ”¶æ¬¾ç 
    if (method === 'alipay' && alipayBox) {
        alipayBox.style.display = '';
    }

    // æ˜¾ç¤ºå¾®ä¿¡æ”¶æ¬¾ç 
    if (method === 'wechat' && wechatBox) {
        wechatBox.style.display = '';
    }
}

function formatStatusBadge(type, text) {
    return `<span class="status-badge status-${type}">${text}</span>`;
}

function payableStatusLabel(status, today, payEnd) {
    const s = Number(status);
    if (s === 2) return { type: 'paid', text: 'å·²ç¼´æ¸…' };
    if (payEnd && today > payEnd) return { type: 'invalid', text: 'é€¾æœŸæœªç¼´æ¸…' };
    if (s === 1) return { type: 'pending', text: 'éƒ¨åˆ†å·²ç¼´' };
    return { type: 'pending', text: 'æœªç¼´' };
}

function paymentStatusLabel(status) {
    const s = Number(status);
    if (s === 1) return { type: 'paid', text: 'å·²ç¡®è®¤' };
    if (s === 2) return { type: 'rejected', text: 'å·²é©³å›' };
    return { type: 'pending', text: 'å¾…å®¡æ ¸' };
}

function banReportStatusLabel(status) {
    const s = Number(status);
    if (s === 1) return { type: 'paid', text: 'å·²é€šè¿‡' };
    if (s === 2) return { type: 'rejected', text: 'å·²é©³å›' };
    return { type: 'pending', text: 'å¾…å®¡æ ¸' };
}

function banReportAppliedLabel(isApplied) {
    return Number(isApplied) === 1 ? { type: 'paid', text: 'å·²åº”ç”¨' } : { type: 'pending', text: 'æœªåº”ç”¨' };
}

function parseDateOnly(yyyyMmDd) {
    if (!yyyyMmDd) return null;
    const parts = String(yyyyMmDd).split('-').map(x => parseInt(x, 10));
    if (parts.length !== 3 || parts.some(n => Number.isNaN(n))) return null;
    return new Date(parts[0], parts[1] - 1, parts[2]);
}

function updateBanDeductHint() {
    const coins = parseInt(document.getElementById('banBannedCoins')?.value || '0', 10) || 0;
    const hint = document.getElementById('banDeductHint');
    if (!hint) return;
    if (coins <= 0) {
        hint.textContent = `å®¡æ ¸é€šè¿‡åæŒ‰æœ¬æœŸè§„åˆ™æ‰£å‡åº”ç¼´ä¸åˆ†æˆï¼ˆåº”ç¼´æ¯”ä¾‹ ${currentCollectBps}/10000ï¼Œ+1 ${currentL1Bps}/10000ï¼Œ+2 ${currentL2Bps}/10000ï¼‰`;
        return;
    }
    const dueDeduct = Math.floor(coins * (currentCollectBps || 0) / 10000);
    hint.textContent = `é¢„è®¡åº”ç¼´æ‰£å‡çº¦ ${dueDeduct} coinsï¼ˆæŒ‰ collect_bps=${currentCollectBps}/10000 ä¼°ç®—ï¼›æœ€ç»ˆä»¥åå°é‡æ–°è®¡ç®—ä¸ºå‡†ï¼‰`;
}

async function loadMyBanReports() {
    const card = document.getElementById('banReportTableCard');
    const tbody = document.getElementById('banReportTableBody');
    if (!card || !tbody) return;

    if (!currentPeriodId) {
        card.style.display = 'none';
        return;
    }

    card.style.display = '';
    tbody.innerHTML = '<tr><td colspan="9" class="loading-cell">åŠ è½½ä¸­...</td></tr>';
    try {
        const reports = await apiRequest(`/settlement-ban-reports/my?period_id=${currentPeriodId}`);
        if (!Array.isArray(reports) || reports.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="empty-cell">æš‚æ— å°å·ææŠ¥è®°å½•</td></tr>';
            return;
        }

        tbody.innerHTML = reports.map(r => {
            const st = banReportStatusLabel(r.status);
            const ap = banReportAppliedLabel(r.is_applied);
            const submittedAt = r.submitted_at ? new Date(r.submitted_at).toLocaleString('zh-CN') : '-';
            const reviewedAt = r.reviewed_at ? new Date(r.reviewed_at).toLocaleString('zh-CN') : '-';
            const proof = r.proof_file_path ? `<a href=\"/${r.proof_file_path}\" target=\"_blank\">æŸ¥çœ‹</a>` : '-';

            const deduct = Number(r.is_applied) === 1
                ? `åº”ç¼´ -${r.deduct_due_coins || 0} | +1 -${r.deduct_l1_commission_coins || 0} | +2 -${r.deduct_l2_commission_coins || 0}`
                : '-';

            return `
                <tr>
                    <td>${r.report_id}</td>
                    <td>${submittedAt}</td>
                    <td>${r.banned_coins} coins</td>
                    <td>${formatStatusBadge(st.type, st.text)}</td>
                    <td>${formatStatusBadge(ap.type, ap.text)}</td>
                    <td>${proof}</td>
                    <td>${deduct}</td>
                    <td>${reviewedAt}</td>
                    <td>${r.reject_reason || '-'}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('åŠ è½½å°å·ææŠ¥å¤±è´¥:', error);
        tbody.innerHTML = `<tr><td colspan=\"9\" class=\"error-cell\">åŠ è½½å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}</td></tr>`;
    }
}

async function loadSettlementCenter() {
    const emptyEl = document.getElementById('settlementEmpty');
    const contentEl = document.getElementById('settlementContent');
    const payFormEl = document.getElementById('settlementPayFormCard');
    const tableBody = document.getElementById('paymentTableBody');
    const hintEl = document.getElementById('paymentHint');

    emptyEl.style.display = 'none';
    contentEl.style.display = 'none';
    payFormEl.style.display = 'none';
    tableBody.innerHTML = '<tr><td colspan="8" class="loading-cell">åŠ è½½ä¸­...</td></tr>';
    hintEl.textContent = '';

    try {
        const payload = await apiRequest('/settlement/me');
        const period = payload.period;
        const income = payload.income || null;
        const payable = payload.payable || null;
        const payments = Array.isArray(payload.payments) ? payload.payments : [];
        currentAlipayQrcodeUrl = payload.alipay_qrcode_url || null;

        if (!period) {
            currentPeriodId = null;
            emptyEl.style.display = '';
            tableBody.innerHTML = '<tr><td colspan="8" class="empty-cell">æš‚æ— æ•°æ®</td></tr>';
            const banForm = document.getElementById('banReportFormCard');
            const banTable = document.getElementById('banReportTableCard');
            if (banForm) banForm.style.display = 'none';
            if (banTable) banTable.style.display = 'none';
            updatePaymentMethodQrcode();
            return;
        }

        currentPeriodId = Number(period.period_id);
        currentCoinRate = Number(period.coin_rate || 10000);
        currentCollectBps = Number(period.collect_bps || 4000);
        currentL1Bps = Number(period.l1_bps || 2000);
        currentL2Bps = Number(period.l2_bps || 400);
        currentDueCoins = payable ? Number(payable.amount_due_coins || 0) : 0;
        currentPaidCoins = payable ? Number(payable.amount_paid_coins || 0) : 0;
        currentPayWindow = { pay_start: period.pay_start, pay_end: period.pay_end };

        document.getElementById('settlementPeriodRange').textContent = `${period.period_start} ~ ${period.period_end}`;
        document.getElementById('settlementPayRange').textContent = `${period.pay_start} ~ ${period.pay_end}`;
        document.getElementById('settlementCoinRate').textContent = String(currentCoinRate);

        const grossCoins = income ? Number(income.gross_coins || 0) : 0;
        document.getElementById('settlementGrossCoins').textContent = `${grossCoins} coins`;
        document.getElementById('settlementGrossYuan').textContent = `ï¿¥${coinsToYuan(grossCoins)}`;

        document.getElementById('settlementDueCoins').textContent = `${currentDueCoins} coins`;
        document.getElementById('settlementDueYuan').textContent = `ï¿¥${coinsToYuan(currentDueCoins)}`;

        document.getElementById('settlementPaidCoins').textContent = `${currentPaidCoins} coins`;
        document.getElementById('settlementPaidYuan').textContent = `ï¿¥${coinsToYuan(currentPaidCoins)}`;

        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const payEnd = parseDateOnly(period.pay_end);
        const st = payableStatusLabel(payable ? payable.status : 0, today, payEnd);
        document.getElementById('settlementStatusText').textContent = st.text;
        document.getElementById('settlementStatusBadge').innerHTML = formatStatusBadge(st.type, st.text);

        contentEl.style.display = '';

        // å°å·ææŠ¥ï¼šæœ‰ç»“ç®—æœŸæ—¶å±•ç¤º
        const banForm = document.getElementById('banReportFormCard');
        if (banForm) banForm.style.display = '';
        updateBanDeductHint();
        await loadMyBanReports();

        // æäº¤ç¼´è´¹åŒºåŸŸï¼šä»…åœ¨æœ‰å‰©ä½™åº”ç¼´æ—¶å±•ç¤º
        const remaining = Math.max(0, currentDueCoins - currentPaidCoins);
        const payStart = parseDateOnly(period.pay_start);
        const inWindow = payStart && payEnd ? (today >= payStart && today <= payEnd) : true;

        if (remaining > 0) {
            payFormEl.style.display = '';
            hintEl.textContent = inWindow
                ? `ğŸ’¡ å‰©ä½™åº”ç¼´ï¼š${remaining} coinsï¼ˆï¿¥${coinsToYuan(remaining)}ï¼‰`
                : `âš ï¸ å½“å‰ä¸åœ¨ç¼´è´¹çª—å£ï¼ˆ${period.pay_start}~${period.pay_end}ï¼‰ï¼Œæäº¤ä¼šè¢«æ‹’ç»ã€‚`;
        }
        updatePaymentMethodQrcode();

        if (payments.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" class="empty-cell">æš‚æ— ç¼´è´¹è®°å½•</td></tr>';
            return;
        }

        tableBody.innerHTML = payments.map(p => {
            const stp = paymentStatusLabel(p.status);
            const proof = p.proof_url ? `<a href="${p.proof_url}" target="_blank">æŸ¥çœ‹</a>` : '-';
            const submittedAt = p.submitted_at ? new Date(p.submitted_at).toLocaleString('zh-CN') : '-';
            const confirmedAt = p.confirmed_at ? new Date(p.confirmed_at).toLocaleString('zh-CN') : '-';
            const amountYuan = (Number(p.amount_coins || 0) / (currentCoinRate || 10000)).toFixed(2);
            return `
                <tr>
                    <td>${p.payment_id}</td>
                    <td>${submittedAt}</td>
                    <td>${p.amount_coins} coinsï¼ˆï¿¥${amountYuan}ï¼‰</td>
                    <td>${p.method || '-'}</td>
                    <td>${formatStatusBadge(stp.type, stp.text)}</td>
                    <td>${proof}</td>
                    <td>${confirmedAt}</td>
                    <td>${p.reject_reason || '-'}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('åŠ è½½ç»“ç®—ä¸­å¿ƒå¤±è´¥:', error);
        document.getElementById('settlementEmpty').style.display = '';
        document.getElementById('settlementEmpty').textContent = error.message || 'åŠ è½½å¤±è´¥';
        tableBody.innerHTML = '<tr><td colspan="8" class="error-cell">åŠ è½½å¤±è´¥</td></tr>';
    }
}

async function submitBanReport() {
    const coins = parseInt(document.getElementById('banBannedCoins')?.value || '0', 10);
    const fileEl = document.getElementById('banProofFile');
    const hintEl = document.getElementById('banReportHint');
    if (hintEl) hintEl.textContent = '';

    if (!currentPeriodId) {
        showToast('å½“å‰æ— ç»“ç®—æœŸï¼Œæ— æ³•æäº¤å°å·ææŠ¥', 'error');
        return;
    }
    if (!coins || coins <= 0) {
        showToast('è¯·å¡«å†™æœ‰æ•ˆçš„è¢«å°ç¦é‡‘é¢ï¼ˆcoinsï¼‰', 'error');
        return;
    }
    const file = fileEl?.files?.[0] || null;
    if (!file) {
        showToast('è¯·ä¸Šä¼ æˆªå›¾', 'error');
        return;
    }

    try {
        const fd = new FormData();
        fd.append('period_id', String(currentPeriodId));
        fd.append('banned_coins', String(coins));
        fd.append('proof_file', file);

        await apiRequestForm('/settlement-ban-reports', fd);
        showToast('å·²æäº¤å°å·ææŠ¥ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸', 'success');
        document.getElementById('banBannedCoins').value = '';
        if (fileEl) fileEl.value = '';
        updateBanDeductHint();
        await loadSettlementCenter();
    } catch (error) {
        if (hintEl) hintEl.textContent = error.message || 'æäº¤å¤±è´¥';
        showToast(error.message || 'æäº¤å¤±è´¥', 'error');
    }
}

async function submitSettlementPayment() {
    const amount = parseInt(document.getElementById('paymentAmountCoins').value, 10);
    const method = document.getElementById('paymentMethod').value;
    const proofUrl = (document.getElementById('paymentProofUrl').value || '').trim() || null;

    if (!currentPeriodId) {
        showToast('å½“å‰æ— ç»“ç®—æœŸ', 'error');
        return;
    }
    if (!amount || amount <= 0) {
        showToast('è¯·å¡«å†™æœ‰æ•ˆçš„ç¼´è´¹é‡‘é¢ï¼ˆcoinsï¼‰', 'error');
        return;
    }

    try {
        await apiRequest('/settlement-payments', {
            method: 'POST',
            body: JSON.stringify({
                period_id: currentPeriodId,
                amount_coins: amount,
                method: method,
                proof_url: proofUrl
            })
        });
        showToast('å·²æäº¤ç¼´è´¹ï¼Œç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸', 'success');
        document.getElementById('paymentAmountCoins').value = '';
        document.getElementById('paymentProofUrl').value = '';
        await loadSettlementCenter();
    } catch (error) {
        showToast(error.message || 'æäº¤å¤±è´¥', 'error');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const methodEl = document.getElementById('paymentMethod');
    if (methodEl) methodEl.addEventListener('change', updatePaymentMethodQrcode);
    const banCoinsEl = document.getElementById('banBannedCoins');
    if (banCoinsEl) banCoinsEl.addEventListener('input', updateBanDeductHint);
    loadSettlementCenter();
});
</script>
{% endblock %}
