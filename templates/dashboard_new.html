{% extends "base.html" %}

{% block title %}ä»ªè¡¨æ¿ - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}ä»ªè¡¨æ¿{% endblock %}

{% block content %}
<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-icon">âš™ï¸</div>
        <div class="stat-content">
            <span class="stat-value" id="statConfigs">0</span>
            <span class="stat-label">è„šæœ¬é…ç½®</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-content">
            <span class="stat-value" id="statTodayCoins">0</span>
            <span class="stat-label">ä»Šæ—¥é‡‘å¸</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ‘›</div>
        <div class="stat-content">
            <span class="stat-value" id="statWalletBalance">Â¥0.00</span>
            <span class="stat-label">é’±åŒ…ä½™é¢</span>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <!-- æˆ‘çš„æ¨å¹¿ç  -->
    <div class="dashboard-card referral-card">
        <div class="card-header">
            <h3>ğŸ æˆ‘çš„æ¨å¹¿ç </h3>
            <a href="/referral" class="view-all-link">æ¨å¹¿ä¸­å¿ƒ â†’</a>
        </div>
        <div class="card-body">
            <div class="referral-code-box">
                <span class="referral-code" id="dashboardReferralCode">åŠ è½½ä¸­...</span>
                <button class="btn btn-secondary btn-sm" onclick="copyDashboardCode()">å¤åˆ¶</button>
            </div>
            <div class="referral-stats">
                <span>ç›´æ¥é‚€è¯·: <strong id="dashboardLevel1">0</strong> äºº</span>
                <span>é—´æ¥é‚€è¯·: <strong id="dashboardLevel2">0</strong> äºº</span>
            </div>
        </div>
    </div>
    
    <!-- å¿«é€Ÿæ“ä½œ -->
    <!-- æ”¶ç›Šè¶‹åŠ¿ -->
    <div class="dashboard-card full-width">
        <div class="card-header">
            <h3>è¿‘7å¤©æ”¶ç›Šè¶‹åŠ¿</h3>
        </div>
        <div class="card-body">
            <div class="earnings-chart" id="earningsChart">
                <div class="chart-bars" id="chartBars">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="chart-labels" id="chartLabels">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- æœ€è¿‘æ´»åŠ¨ -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3>æœ€è¿‘æ´»åŠ¨</h3>
        </div>
        <div class="card-body">
            <div class="activity-list" id="activityList">
                <div class="loading-placeholder">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- å¾…å¤„ç†äº‹é¡¹ -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3>å¾…å¤„ç†äº‹é¡¹</h3>
        </div>
        <div class="card-body">
            <div class="todo-list" id="todoList">
                <div class="todo-item warning">
                    <span class="todo-icon">âš ï¸</span>
                    <span class="todo-text">æš‚æ— å¾…å¤„ç†äº‹é¡¹</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.referral-card .referral-code-box {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}
.referral-card .referral-code {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary-color);
    letter-spacing: 2px;
    background: var(--bg-color);
    padding: 8px 16px;
    border-radius: 6px;
}
.referral-card .referral-stats {
    display: flex;
    gap: 20px;
    font-size: 13px;
    color: var(--text-muted);
}
.referral-card .referral-stats strong {
    color: var(--primary-color);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    loadEarningsChart();
    loadReferralInfo();
});

async function loadReferralInfo() {
    try {
        const info = await apiRequest('/me/referral');
        document.getElementById('dashboardReferralCode').textContent = info.my_referral_code;
        document.getElementById('dashboardLevel1').textContent = info.level1_count;
        document.getElementById('dashboardLevel2').textContent = info.level2_count;
    } catch (error) {
        document.getElementById('dashboardReferralCode').textContent = '-';
    }
}

function copyDashboardCode() {
    const code = document.getElementById('dashboardReferralCode').textContent;
    if (code && code !== 'åŠ è½½ä¸­...' && code !== '-') {
        navigator.clipboard.writeText(code).then(() => {
            showToast('æ¨å¹¿ç å·²å¤åˆ¶', 'success');
        }).catch(() => {
            showToast('å¤åˆ¶å¤±è´¥', 'error');
        });
    }
}

async function loadDashboardStats() {
    try {
        const stats = await apiRequest('/stats/dashboard');
        document.getElementById('statConfigs').textContent = stats.total_configs || 0;
        document.getElementById('statTodayCoins').textContent = formatNumber(stats.today_coins || 0);
        document.getElementById('statWalletBalance').textContent = 'Â¥' + (stats.wallet_balance || 0).toFixed(2);
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
}

async function loadEarningsChart() {
    const barsContainer = document.getElementById('chartBars');
    const labelsContainer = document.getElementById('chartLabels');
    
    try {
        const data = await apiRequest('/stats/earnings-weekly');
        if (data && data.length > 0) {
            const maxValue = Math.max(...data.map(d => d.coins_total));
            barsContainer.innerHTML = data.map(d => {
                const height = maxValue > 0 ? (d.coins_total / maxValue * 100) : 0;
                return `<div class="chart-bar" style="height: ${height}%" title="${formatNumber(d.coins_total)} é‡‘å¸"></div>`;
            }).join('');
            labelsContainer.innerHTML = data.map(d => `<span>${d.date.substring(5)}</span>`).join('');
        } else {
            barsContainer.innerHTML = '<div class="empty-placeholder">æš‚æ— æ•°æ®</div>';
        }
    } catch (error) {
        barsContainer.innerHTML = '<div class="error-placeholder">åŠ è½½å¤±è´¥</div>';
    }
}

function formatNumber(num) {
    if (num >= 10000) {
        return (num / 10000).toFixed(1) + 'ä¸‡';
    }
    return num.toString();
}
</script>
{% endblock %}
