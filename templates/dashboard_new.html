{% extends "base.html" %}

{% block title %}ä»ªè¡¨æ¿ - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}ä»ªè¡¨æ¿{% endblock %}

{% block content %}
<!-- æ–°æ‰‹å¼•å¯¼å¡ç‰‡ -->
<div class="guide-card">
    <div class="guide-header">
        <div class="guide-icon">ğŸ“–</div>
        <div class="guide-title">
            <h3>æ–°æ‰‹å…¥é—¨æŒ‡å—</h3>
            <p>å¿«é€Ÿå¼€å§‹ä½¿ç”¨å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°</p>
        </div>
    </div>
    <div class="guide-body">
        <div class="guide-item">
            <span class="guide-item-icon">ğŸ“±</span>
            <div class="guide-item-content">
                <h4>ä¸‹è½½å¿«æ‰‹æé€Ÿç‰ˆ</h4>
                <p>è¯·ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„å¿«æ‰‹æé€Ÿç‰ˆ APPï¼Œç¡®ä¿è„šæœ¬æ­£å¸¸è¿è¡Œ</p>
                <a href="/data/software/å¿«æ‰‹æé€Ÿç‰ˆ13.9.10.10684å…rootä¸€é”®(æ¨è).apk"
                   class="btn btn-primary btn-sm"
                   download>
                    <span>ğŸ“¥</span> ä¸‹è½½ APK å®‰è£…åŒ…
                </a>
            </div>
        </div>
        <div class="guide-item">
            <span class="guide-item-icon">ğŸ“„</span>
            <div class="guide-item-content">
                <h4>æŸ¥çœ‹æ­å»ºè¯´æ˜</h4>
                <p>è¯¦ç»†çš„æ–°æ‰‹æ­å»ºæ•™ç¨‹ï¼Œå¸®åŠ©ä½ å¿«é€Ÿä¸Šæ‰‹</p>
                <button class="btn btn-secondary btn-sm" onclick="showGuideDocument()">
                    <span>ğŸ‘ï¸</span> æŸ¥çœ‹è¯´æ˜æ–‡æ¡£
                </button>
            </div>
        </div>
    </div>
</div>

<div class="dashboard-stats">
    <div class="stat-card">
        <div class="stat-icon">âš™ï¸</div>
        <div class="stat-content">
            <span class="stat-value" id="statConfigs">0</span>
            <span class="stat-label">è„šæœ¬é…ç½®</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-content">
            <span class="stat-value" id="statTodayCoins">0</span>
            <span class="stat-label">ä»Šæ—¥é‡‘å¸</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ‘›</div>
        <div class="stat-content">
            <span class="stat-value" id="statWalletBalance">Â¥0.00</span>
            <span class="stat-label">é’±åŒ…ä½™é¢</span>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <!-- æˆ‘çš„æ¨å¹¿ç  -->
    <div class="dashboard-card referral-card">
        <div class="card-header">
            <h3>ğŸ æˆ‘çš„æ¨å¹¿ç </h3>
            <a href="/referral" class="view-all-link">æ¨å¹¿ä¸­å¿ƒ â†’</a>
        </div>
        <div class="card-body">
            <div class="referral-code-box">
                <span class="referral-code" id="dashboardReferralCode">åŠ è½½ä¸­...</span>
                <button class="btn btn-secondary btn-sm" onclick="copyDashboardCode()">å¤åˆ¶</button>
            </div>
            <div class="referral-stats">
                <span>ç›´æ¥é‚€è¯·: <strong id="dashboardLevel1">0</strong> äºº</span>
                <span>é—´æ¥é‚€è¯·: <strong id="dashboardLevel2">0</strong> äºº</span>
            </div>
        </div>
    </div>
    
    <!-- å¿«é€Ÿæ“ä½œ -->
    <!-- æ”¶ç›Šè¶‹åŠ¿ -->
    <div class="dashboard-card full-width">
        <div class="card-header">
            <h3>è¿‘7å¤©æ”¶ç›Šè¶‹åŠ¿</h3>
        </div>
        <div class="card-body">
            <div class="earnings-chart" id="earningsChart">
                <div class="chart-bars" id="chartBars">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="chart-labels" id="chartLabels">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- æœ€è¿‘æ´»åŠ¨ -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3>æœ€è¿‘æ´»åŠ¨</h3>
        </div>
        <div class="card-body">
            <div class="activity-list" id="activityList">
                <div class="loading-placeholder">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- å¾…å¤„ç†äº‹é¡¹ -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3>å¾…å¤„ç†äº‹é¡¹</h3>
        </div>
        <div class="card-body">
            <div class="todo-list" id="todoList">
                <div class="todo-item warning">
                    <span class="todo-icon">âš ï¸</span>
                    <span class="todo-text">æš‚æ— å¾…å¤„ç†äº‹é¡¹</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* æ–°æ‰‹å¼•å¯¼å¡ç‰‡æ ·å¼ */
.guide-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 24px;
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}
.guide-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
}
.guide-icon {
    font-size: 40px;
    background: rgba(255,255,255,0.2);
    width: 64px;
    height: 64px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
}
.guide-title h3 {
    margin: 0 0 4px 0;
    font-size: 20px;
    font-weight: 600;
}
.guide-title p {
    margin: 0;
    opacity: 0.9;
    font-size: 14px;
}
.guide-body {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 16px;
}
.guide-item {
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
    padding: 16px;
    display: flex;
    gap: 12px;
    backdrop-filter: blur(10px);
}
.guide-item-icon {
    font-size: 28px;
    flex-shrink: 0;
}
.guide-item-content h4 {
    margin: 0 0 6px 0;
    font-size: 16px;
    font-weight: 600;
}
.guide-item-content p {
    margin: 0 0 12px 0;
    font-size: 13px;
    opacity: 0.9;
    line-height: 1.5;
}
.guide-item .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.guide-item .btn-primary {
    background: white;
    color: #667eea;
    border: none;
}
.guide-item .btn-primary:hover {
    background: #f0f0f0;
}
.guide-item .btn-secondary {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
}
.guide-item .btn-secondary:hover {
    background: rgba(255,255,255,0.3);
}

/* æ–‡æ¡£æ¨¡æ€æ¡†æ ·å¼ */
.guide-modal-content {
    max-height: 70vh;
    overflow-y: auto;
    padding: 20px;
    line-height: 1.8;
}
.guide-modal-content h1, .guide-modal-content h2, .guide-modal-content h3 {
    color: var(--primary-color);
    margin-top: 20px;
    margin-bottom: 10px;
}
.guide-modal-content h1 { font-size: 24px; }
.guide-modal-content h2 { font-size: 20px; }
.guide-modal-content h3 { font-size: 18px; }
.guide-modal-content p {
    margin-bottom: 12px;
    color: var(--text-color);
}
.guide-modal-content .doc-table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
}
.guide-modal-content .doc-table td {
    border: 1px solid var(--border-color);
    padding: 10px;
}
.guide-modal-content .loading-text {
    text-align: center;
    padding: 40px;
    color: var(--text-muted);
}

/* æ¨å¹¿ç å¡ç‰‡æ ·å¼ */
.referral-card .referral-code-box {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
}
.referral-card .referral-code {
    font-size: 24px;
    font-weight: 700;
    color: var(--primary-color);
    letter-spacing: 2px;
    background: var(--bg-color);
    padding: 8px 16px;
    border-radius: 6px;
}
.referral-card .referral-stats {
    display: flex;
    gap: 20px;
    font-size: 13px;
    color: var(--text-muted);
}
.referral-card .referral-stats strong {
    color: var(--primary-color);
}

/* å“åº”å¼é€‚é… */
@media (max-width: 768px) {
    .guide-card {
        padding: 16px;
    }
    .guide-header {
        flex-direction: column;
        text-align: center;
    }
    .guide-body {
        grid-template-columns: 1fr;
    }
    .guide-item {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    loadEarningsChart();
    loadReferralInfo();
});

async function loadReferralInfo() {
    try {
        const info = await apiRequest('/me/referral');
        document.getElementById('dashboardReferralCode').textContent = info.my_referral_code;
        document.getElementById('dashboardLevel1').textContent = info.level1_count;
        document.getElementById('dashboardLevel2').textContent = info.level2_count;
    } catch (error) {
        document.getElementById('dashboardReferralCode').textContent = '-';
    }
}

function copyDashboardCode() {
    const code = document.getElementById('dashboardReferralCode').textContent;
    if (code && code !== 'åŠ è½½ä¸­...' && code !== '-') {
        navigator.clipboard.writeText(code).then(() => {
            showToast('æ¨å¹¿ç å·²å¤åˆ¶', 'success');
        }).catch(() => {
            showToast('å¤åˆ¶å¤±è´¥', 'error');
        });
    }
}

async function loadDashboardStats() {
    try {
        const stats = await apiRequest('/stats/dashboard');
        document.getElementById('statConfigs').textContent = stats.total_configs || 0;
        document.getElementById('statTodayCoins').textContent = formatNumber(stats.today_coins || 0);
        document.getElementById('statWalletBalance').textContent = 'Â¥' + (stats.wallet_balance || 0).toFixed(2);
    } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
    }
}

async function loadEarningsChart() {
    const barsContainer = document.getElementById('chartBars');
    const labelsContainer = document.getElementById('chartLabels');
    
    try {
        const data = await apiRequest('/stats/earnings-weekly');
        if (data && data.length > 0) {
            const maxValue = Math.max(...data.map(d => d.coins_total));
            barsContainer.innerHTML = data.map(d => {
                const height = maxValue > 0 ? (d.coins_total / maxValue * 100) : 0;
                return `<div class="chart-bar" style="height: ${height}%" title="${formatNumber(d.coins_total)} é‡‘å¸"></div>`;
            }).join('');
            labelsContainer.innerHTML = data.map(d => `<span>${d.date.substring(5)}</span>`).join('');
        } else {
            barsContainer.innerHTML = '<div class="empty-placeholder">æš‚æ— æ•°æ®</div>';
        }
    } catch (error) {
        barsContainer.innerHTML = '<div class="error-placeholder">åŠ è½½å¤±è´¥</div>';
    }
}

function formatNumber(num) {
    if (num >= 10000) {
        return (num / 10000).toFixed(1) + 'ä¸‡';
    }
    return num.toString();
}

// æ˜¾ç¤ºæ–°æ‰‹æ­å»ºè¯´æ˜æ–‡æ¡£
async function showGuideDocument() {
    const modalOverlay = document.getElementById('modalOverlay');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalFooter = document.getElementById('modalFooter');

    // è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜
    modalTitle.textContent = 'ğŸ“– æ–°æ‰‹æ­å»ºè¯´æ˜';

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    modalBody.innerHTML = '<div class="guide-modal-content"><div class="loading-text">ğŸ“„ æ­£åœ¨åŠ è½½æ–‡æ¡£å†…å®¹...</div></div>';

    // éšè—ç¡®è®¤æŒ‰é’®ï¼Œåªæ˜¾ç¤ºå…³é—­æŒ‰é’®
    modalFooter.innerHTML = '<button class="btn btn-primary" onclick="closeGlobalModal()">å…³é—­</button>';

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    modalOverlay.style.display = 'flex';

    try {
        const response = await fetch('/api/guide/content');
        const data = await response.json();

        if (response.ok) {
            modalBody.innerHTML = `<div class="guide-modal-content">${data.content}</div>`;
        } else {
            modalBody.innerHTML = `<div class="guide-modal-content"><div class="loading-text">âŒ ${data.detail || 'åŠ è½½æ–‡æ¡£å¤±è´¥'}</div></div>`;
        }
    } catch (error) {
        modalBody.innerHTML = '<div class="guide-modal-content"><div class="loading-text">âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</div></div>';
    }
}
</script>
{% endblock %}
