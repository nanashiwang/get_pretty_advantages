{% extends "base.html" %}

{% block title %}æˆ‘çš„é’±åŒ… - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}æˆ‘çš„é’±åŒ…{% endblock %}

{% block content %}
<div class="wallet-overview">
    <div class="wallet-balance-card">
        <div class="balance-icon">ğŸ‘›</div>
        <div class="balance-info">
            <span class="balance-label">å¯ç”¨ä½™é¢</span>
            <span class="balance-value" id="walletBalance">Â¥0.00</span>
        </div>
        <button class="btn btn-primary" onclick="openWithdrawModal()">ç”³è¯·æç°</button>
    </div>
</div>

<div class="stats-overview">
    <div class="stat-card">
        <div class="stat-icon">ğŸ“ˆ</div>
        <div class="stat-content">
            <span class="stat-value" id="totalIncome">Â¥0.00</span>
            <span class="stat-label">ç´¯è®¡æ”¶å…¥</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ’³</div>
        <div class="stat-content">
            <span class="stat-value" id="totalWithdraw">Â¥0.00</span>
            <span class="stat-label">ç´¯è®¡æç°</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ</div>
        <div class="stat-content">
            <span class="stat-value" id="inviteReward">Â¥0.00</span>
            <span class="stat-label">é‚€è¯·å¥–åŠ±</span>
        </div>
    </div>
</div>

<div class="data-card">
    <div class="card-header">
        <h3>äº¤æ˜“è®°å½•</h3>
        <div class="filter-group">
            <select id="typeFilter" onchange="filterTransactions()">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="settlement_income">ç»“ç®—æ”¶å…¥</option>
                <option value="invite_reward">é‚€è¯·å¥–åŠ±</option>
                <option value="withdraw">æç°</option>
                <option value="adjust">è°ƒæ•´</option>
            </select>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="transactionsTable">
            <thead>
                <tr>
                    <th>æ—¶é—´</th>
                    <th>ç±»å‹</th>
                    <th>é‡‘é¢</th>
                    <th>è¯´æ˜</th>
                </tr>
            </thead>
            <tbody id="transactionsTableBody">
                <tr><td colspan="4" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<!-- æç°æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="withdrawModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>ç”³è¯·æç°</h3>
            <button class="modal-close" onclick="closeWithdrawModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="withdraw-info">
                <p>å½“å‰å¯æç°ä½™é¢: <strong id="withdrawableBalance">Â¥0.00</strong></p>
                <p class="info-text">æç°å°†åœ¨1-3ä¸ªå·¥ä½œæ—¥å†…å¤„ç†</p>
            </div>
            <form id="withdrawForm">
                <div class="form-group">
                    <label>æç°é‡‘é¢ <span class="required">*</span></label>
                    <input type="number" id="withdrawAmount" step="0.01" min="1" placeholder="è¯·è¾“å…¥æç°é‡‘é¢" required>
                </div>
                <div class="form-group">
                    <label>æç°æ–¹å¼</label>
                    <select id="withdrawMethod">
                        <option value="wechat">å¾®ä¿¡</option>
                        <option value="alipay">æ”¯ä»˜å®</option>
                        <option value="bank">é“¶è¡Œå¡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ”¶æ¬¾è´¦å·</label>
                    <input type="text" id="withdrawAccount" placeholder="æ”¶æ¬¾è´¦å·/å¾®ä¿¡å·">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <input type="text" id="withdrawRemark" placeholder="å¯é€‰å¤‡æ³¨">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeWithdrawModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="submitWithdraw()">ç¡®è®¤æç°</button>
        </div>
    </div>
</div>

<script>
let walletData = null;
let transactions = [];

document.addEventListener('DOMContentLoaded', function() {
    loadWallet();
    loadTransactions();
});

async function loadWallet() {
    try {
        walletData = await apiRequest('/wallet');
        document.getElementById('walletBalance').textContent = 'Â¥' + (walletData.balance || 0).toFixed(2);
        document.getElementById('withdrawableBalance').textContent = 'Â¥' + (walletData.balance || 0).toFixed(2);
    } catch (error) {
        console.error('åŠ è½½é’±åŒ…å¤±è´¥:', error);
    }
}

async function loadTransactions() {
    const tbody = document.getElementById('transactionsTableBody');
    try {
        transactions = await apiRequest('/wallet/transactions');
        renderTransactions(transactions);
        calculateStats();
    } catch (error) {
        tbody.innerHTML = '<tr><td colspan="4" class="error-cell">åŠ è½½å¤±è´¥</td></tr>';
    }
}

function renderTransactions(data) {
    const tbody = document.getElementById('transactionsTableBody');
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-cell">æš‚æ— äº¤æ˜“è®°å½•</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(t => {
        const isPositive = parseFloat(t.amount) > 0;
        return `
            <tr>
                <td>${new Date(t.created_at).toLocaleString('zh-CN')}</td>
                <td>${getTransactionType(t.type)}</td>
                <td class="${isPositive ? 'amount-positive' : 'amount-negative'}">
                    ${isPositive ? '+' : ''}Â¥${parseFloat(t.amount).toFixed(2)}
                </td>
                <td>${t.description || '-'}</td>
            </tr>
        `;
    }).join('');
}

function filterTransactions() {
    const type = document.getElementById('typeFilter').value;
    const filtered = type ? transactions.filter(t => t.type === type) : transactions;
    renderTransactions(filtered);
}

function calculateStats() {
    let income = 0, withdraw = 0, reward = 0;
    transactions.forEach(t => {
        const amount = parseFloat(t.amount);
        if (t.type === 'settlement_income') income += amount;
        else if (t.type === 'withdraw') withdraw += Math.abs(amount);
        else if (t.type === 'invite_reward') reward += amount;
    });
    
    document.getElementById('totalIncome').textContent = 'Â¥' + income.toFixed(2);
    document.getElementById('totalWithdraw').textContent = 'Â¥' + withdraw.toFixed(2);
    document.getElementById('inviteReward').textContent = 'Â¥' + reward.toFixed(2);
}

function getTransactionType(type) {
    const map = {
        'settlement_income': 'ç»“ç®—æ”¶å…¥',
        'invite_reward': 'é‚€è¯·å¥–åŠ±',
        'withdraw': 'æç°',
        'adjust': 'è°ƒæ•´'
    };
    return map[type] || type;
}

function openWithdrawModal() {
    document.getElementById('withdrawForm').reset();
    document.getElementById('withdrawModal').style.display = 'flex';
}

function closeWithdrawModal() {
    document.getElementById('withdrawModal').style.display = 'none';
}

async function submitWithdraw() {
    const amount = parseFloat(document.getElementById('withdrawAmount').value);
    
    if (!amount || amount <= 0) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æç°é‡‘é¢', 'warning');
        return;
    }
    
    if (walletData && amount > walletData.balance) {
        showToast('æç°é‡‘é¢ä¸èƒ½è¶…è¿‡å¯ç”¨ä½™é¢', 'warning');
        return;
    }
    
    const data = {
        amount: amount,
        method: document.getElementById('withdrawMethod').value,
        account: document.getElementById('withdrawAccount').value,
        remark: document.getElementById('withdrawRemark').value
    };
    
    try {
        await apiRequest('/wallet/withdraw', { method: 'POST', body: JSON.stringify(data) });
        showToast('æç°ç”³è¯·å·²æäº¤', 'success');
        closeWithdrawModal();
        loadWallet();
        loadTransactions();
    } catch (error) {
        showToast('æç°å¤±è´¥: ' + error.message, 'error');
    }
}
</script>
{% endblock %}
