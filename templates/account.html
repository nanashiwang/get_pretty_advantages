{% extends "base.html" %}

{% block title %}个人账户{% endblock %}
{% block page_title %}个人账户{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header between">
        <div>
            <h3>个人资料</h3>
            <p class="text-muted">修改昵称、用户名、手机号、密码，以及重新绑定上级。</p>
        </div>
    </div>
    <div class="card-body">
        <div class="form-grid">
            <div class="form-group">
                <label>用户名</label>
                <input type="text" id="accUsername" placeholder="用户名">
            </div>
            <div class="form-group">
                <label>昵称</label>
                <input type="text" id="accNickname" placeholder="昵称">
            </div>
            <div class="form-group">
                <label>手机号</label>
                <input type="text" id="accPhone" placeholder="手机号">
            </div>
            <div class="form-group">
                <label>微信ID</label>
                <input type="text" id="accWechat" placeholder="微信ID">
            </div>
        </div>
        <div class="form-actions">
            <button class="btn btn-primary" id="saveProfile">保存资料</button>
        </div>

        <div class="divider"></div>

        <h4>修改密码</h4>
        <div class="form-grid">
            <div class="form-group">
                <label>新密码</label>
                <input type="password" id="accPassword" placeholder="新密码">
            </div>
        </div>
        <div class="form-actions">
            <button class="btn btn-secondary" id="savePassword">更新密码</button>
        </div>

        <div class="divider"></div>

        <h4>修改上级</h4>
        <div class="form-grid">
            <div class="form-group">
                <label>邀请码 / 上级推广码</label>
                <input type="text" id="accInviteCode" placeholder="输入邀请码">
            </div>
        </div>
        <div class="form-actions">
            <button class="btn btn-secondary" id="saveInviter">更新上级</button>
        </div>
    </div>
</div>

<script>
let me = null;

document.addEventListener('DOMContentLoaded', () => {
    loadProfile();
    document.getElementById('saveProfile').addEventListener('click', updateProfile);
    document.getElementById('savePassword').addEventListener('click', updatePassword);
    document.getElementById('saveInviter').addEventListener('click', updateInviter);
});

async function loadProfile() {
    try {
        me = await apiRequest('/account/me');
        document.getElementById('accUsername').value = me.username || '';
        document.getElementById('accNickname').value = me.nickname || '';
        document.getElementById('accPhone').value = me.phone || '';
        document.getElementById('accWechat').value = me.wechat_id || '';
    } catch (err) {
        showToast(err.message || '加载失败', 'error');
    }
}

async function updateProfile() {
    const payload = {
        username: document.getElementById('accUsername').value.trim() || null,
        nickname: document.getElementById('accNickname').value.trim() || null,
        phone: document.getElementById('accPhone').value.trim() || null,
        wechat_id: document.getElementById('accWechat').value.trim() || null,
    };
    try {
        me = await apiRequest('/account/profile', { method: 'PUT', body: JSON.stringify(payload) });
        showToast('资料已更新', 'success');
    } catch (err) {
        showToast(err.message || '更新失败', 'error');
    }
}

async function updatePassword() {
    const newPwd = document.getElementById('accPassword').value;
    if (!newPwd || newPwd.length < 6) {
        showToast('密码至少6位', 'warning');
        return;
    }
    try {
        await apiRequest('/account/password', { method: 'PUT', body: JSON.stringify({ new_password: newPwd }) });
        showToast('密码已更新', 'success');
        document.getElementById('accPassword').value = '';
    } catch (err) {
        showToast(err.message || '更新失败', 'error');
    }
}

async function updateInviter() {
    const code = document.getElementById('accInviteCode').value.trim();
    if (!code) {
        showToast('请输入邀请码', 'warning');
        return;
    }
    try {
        await apiRequest('/account/inviter', { method: 'PUT', body: JSON.stringify({ invite_code: code }) });
        showToast('上级已更新', 'success');
    } catch (err) {
        showToast(err.message || '更新失败', 'error');
    }
}
</script>
{% endblock %}
