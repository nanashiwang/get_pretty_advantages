{% extends "base.html" %}

{% block title %}æ¨å¹¿ä¸­å¿ƒ - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}æ¨å¹¿ä¸­å¿ƒ{% endblock %}

{% block content %}
<div class="referral-overview">
    <!-- æˆ‘çš„æ¨å¹¿ç  -->
    <div class="referral-code-card">
        <div class="card-header">
            <h3>ğŸ æˆ‘çš„æ¨å¹¿ç </h3>
        </div>
        <div class="card-body">
            <div class="referral-code-display">
                <span class="code" id="myReferralCode">åŠ è½½ä¸­...</span>
                <button class="btn btn-secondary btn-sm" onclick="copyReferralCode()">ğŸ“‹ å¤åˆ¶</button>
            </div>
            <p class="code-tip">åˆ†äº«æ­¤æ¨å¹¿ç ç»™å¥½å‹ï¼Œå¥½å‹æ³¨å†Œæ—¶å¡«å†™å¯å»ºç«‹æ¨å¹¿å…³ç³»</p>
            <div class="share-link">
                <label>æ¨å¹¿é“¾æ¥:</label>
                <input type="text" id="shareLink" readonly onclick="this.select()">
                <button class="btn btn-secondary btn-sm" onclick="copyShareLink()">å¤åˆ¶é“¾æ¥</button>
            </div>
        </div>
    </div>
</div>

<div class="stats-overview">
    <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-content">
            <span class="stat-value" id="level1Count">0</span>
            <span class="stat-label">ç›´æ¥é‚€è¯· (+1)</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ”—</div>
        <div class="stat-content">
            <span class="stat-value" id="level2Count">0</span>
            <span class="stat-label">é—´æ¥é‚€è¯· (+2)</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">ğŸ’°</div>
        <div class="stat-content">
            <span class="stat-value" id="totalReward">Â¥0.00</span>
            <span class="stat-label">ç´¯è®¡å¥–åŠ±</span>
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <!-- æˆ‘çš„é‚€è¯·äºº -->
    <div class="dashboard-card">
        <div class="card-header">
            <h3>æˆ‘çš„é‚€è¯·äºº</h3>
        </div>
        <div class="card-body">
            <div id="inviterInfo">
                <div class="loading-placeholder">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    
    <!-- ç»‘å®šé‚€è¯·äºº -->
    <div class="dashboard-card" id="bindInviterCard">
        <div class="card-header">
            <h3>ç»‘å®šé‚€è¯·äºº</h3>
        </div>
        <div class="card-body">
            <form id="bindInviterForm">
                <div class="form-group">
                    <label>é‚€è¯·ç  / æ¨å¹¿ç </label>
                    <input type="text" id="inviteCodeInput" placeholder="è¯·è¾“å…¥é‚€è¯·äººçš„æ¨å¹¿ç ">
                </div>
                <button type="submit" class="btn btn-primary">ç¡®è®¤ç»‘å®š</button>
            </form>
            <p class="form-tip">æ³¨æ„ï¼šç»‘å®šåæ— æ³•ä¿®æ”¹ï¼Œè¯·ç¡®è®¤é‚€è¯·ç æ­£ç¡®</p>
        </div>
    </div>
</div>

<!-- æˆ‘é‚€è¯·çš„ç”¨æˆ·åˆ—è¡¨ -->
<div class="data-card">
    <div class="card-header">
        <h3>æˆ‘é‚€è¯·çš„ç”¨æˆ·</h3>
        <div class="tabs-inline">
            <button class="tab-btn active" onclick="switchInviteTab('level1')">ç›´æ¥é‚€è¯· (+1)</button>
            <button class="tab-btn" onclick="switchInviteTab('level2')">é—´æ¥é‚€è¯· (+2)</button>
        </div>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="invitedUsersTable">
            <thead>
                <tr>
                    <th>ç”¨æˆ·å</th>
                    <th>æ˜µç§°</th>
                    <th>æ³¨å†Œæ—¶é—´</th>
                    <th>å…³ç³»</th>
                </tr>
            </thead>
            <tbody id="invitedUsersBody">
                <tr><td colspan="4" class="loading-cell">åŠ è½½ä¸­...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<style>
.referral-code-card {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 16px;
    color: white;
    margin-bottom: 30px;
}

.referral-code-card .card-header {
    border-bottom: 1px solid rgba(255,255,255,0.2);
    padding: 20px;
}

.referral-code-card .card-header h3 {
    color: white;
    margin: 0;
}

.referral-code-card .card-body {
    padding: 25px;
}

.referral-code-display {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.referral-code-display .code {
    font-size: 32px;
    font-weight: 700;
    letter-spacing: 3px;
    background: rgba(255,255,255,0.2);
    padding: 10px 25px;
    border-radius: 8px;
}

.referral-code-display .btn {
    background: white;
    color: var(--primary-color);
}

.code-tip {
    opacity: 0.9;
    font-size: 14px;
    margin-bottom: 20px;
}

.share-link {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(255,255,255,0.1);
    padding: 15px;
    border-radius: 8px;
}

.share-link label {
    font-weight: 500;
    white-space: nowrap;
}

.share-link input {
    flex: 1;
    background: rgba(255,255,255,0.9);
    color: #333;
    border: none;
    padding: 10px;
    border-radius: 6px;
    font-size: 13px;
}

.share-link .btn {
    background: white;
    color: var(--primary-color);
}

.inviter-info-box {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: var(--bg-color);
    border-radius: 8px;
}

.inviter-avatar {
    width: 50px;
    height: 50px;
    background: var(--primary-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    font-weight: 600;
}

.inviter-details {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.inviter-name {
    font-weight: 600;
    font-size: 16px;
}

.inviter-label {
    font-size: 12px;
    color: var(--text-muted);
}

.no-inviter {
    text-align: center;
    padding: 20px;
    color: var(--text-muted);
}

.form-tip {
    margin-top: 15px;
    font-size: 12px;
    color: var(--text-muted);
}

.tabs-inline {
    display: flex;
    gap: 5px;
}

.tabs-inline .tab-btn {
    padding: 6px 12px;
    font-size: 13px;
}
</style>

<script>
let referralInfo = null;
let invitedUsers = [];
let currentTab = 'level1';

document.addEventListener('DOMContentLoaded', function() {
    loadReferralInfo();
    loadInvitedUsers();
});

async function loadReferralInfo() {
    try {
        referralInfo = await apiRequest('/me/referral');
        
        // æ˜¾ç¤ºæ¨å¹¿ç 
        document.getElementById('myReferralCode').textContent = referralInfo.my_referral_code;
        
        // ç”Ÿæˆæ¨å¹¿é“¾æ¥
        const shareLink = `${window.location.origin}/register?invite=${referralInfo.my_referral_code}`;
        document.getElementById('shareLink').value = shareLink;
        
        // æ˜¾ç¤ºç»Ÿè®¡
        document.getElementById('level1Count').textContent = referralInfo.level1_count;
        document.getElementById('level2Count').textContent = referralInfo.level2_count;
        
        // æ˜¾ç¤ºé‚€è¯·äººä¿¡æ¯
        const inviterContainer = document.getElementById('inviterInfo');
        const bindCard = document.getElementById('bindInviterCard');
        
        if (referralInfo.inviter) {
            inviterContainer.innerHTML = `
                <div class="inviter-info-box">
                    <div class="inviter-avatar">${(referralInfo.inviter.nickname || referralInfo.inviter.username).charAt(0).toUpperCase()}</div>
                    <div class="inviter-details">
                        <span class="inviter-name">${referralInfo.inviter.nickname || referralInfo.inviter.username}</span>
                        <span class="inviter-label">æˆ‘çš„é‚€è¯·äºº (+1)</span>
                    </div>
                </div>
            `;
            // å·²ç»‘å®šé‚€è¯·äººï¼Œéšè—ç»‘å®šè¡¨å•
            bindCard.style.display = 'none';
        } else {
            inviterContainer.innerHTML = `
                <div class="no-inviter">
                    <p>æš‚æœªç»‘å®šé‚€è¯·äºº</p>
                    <p style="font-size: 12px;">æ‚¨å¯ä»¥åœ¨å³ä¾§ç»‘å®šé‚€è¯·äººï¼Œç»‘å®šåæ— æ³•ä¿®æ”¹</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('åŠ è½½æ¨å¹¿ä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('myReferralCode').textContent = 'åŠ è½½å¤±è´¥';
    }
}

async function loadInvitedUsers() {
    try {
        const data = await apiRequest('/referrals/my-invites');
        
        // è·å–ç”¨æˆ·è¯¦æƒ…
        const users = await apiRequest('/users');
        const userMap = {};
        users.forEach(u => userMap[u.id] = u);
        
        invitedUsers = {
            level1: data.level1_users.map(id => ({...userMap[id], level: '+1'})).filter(u => u.username),
            level2: data.level2_users.map(id => ({...userMap[id], level: '+2'})).filter(u => u.username)
        };
        
        renderInvitedUsers();
    } catch (error) {
        console.error('åŠ è½½é‚€è¯·ç”¨æˆ·å¤±è´¥:', error);
        document.getElementById('invitedUsersBody').innerHTML = 
            '<tr><td colspan="4" class="error-cell">åŠ è½½å¤±è´¥</td></tr>';
    }
}

function renderInvitedUsers() {
    const tbody = document.getElementById('invitedUsersBody');
    const data = currentTab === 'level1' ? invitedUsers.level1 : invitedUsers.level2;
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-cell">æš‚æ— é‚€è¯·è®°å½•</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(u => `
        <tr>
            <td>${u.username}</td>
            <td>${u.nickname || '-'}</td>
            <td>${new Date(u.created_at).toLocaleDateString('zh-CN')}</td>
            <td><span class="role-badge role-agent">${u.level}</span></td>
        </tr>
    `).join('');
}

function switchInviteTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tabs-inline .tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderInvitedUsers();
}

function copyReferralCode() {
    const code = document.getElementById('myReferralCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        showToast('æ¨å¹¿ç å·²å¤åˆ¶', 'success');
    }).catch(() => {
        showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
    });
}

function copyShareLink() {
    const link = document.getElementById('shareLink').value;
    navigator.clipboard.writeText(link).then(() => {
        showToast('æ¨å¹¿é“¾æ¥å·²å¤åˆ¶', 'success');
    }).catch(() => {
        showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
    });
}

// ç»‘å®šé‚€è¯·äººè¡¨å•
document.getElementById('bindInviterForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const inviteCode = document.getElementById('inviteCodeInput').value.trim();
    if (!inviteCode) {
        showToast('è¯·è¾“å…¥é‚€è¯·ç ', 'warning');
        return;
    }
    
    if (!confirm('ç»‘å®šåæ— æ³•ä¿®æ”¹ï¼Œç¡®å®šè¦ç»‘å®šæ­¤é‚€è¯·äººå—ï¼Ÿ')) {
        return;
    }
    
    try {
        const result = await apiRequest('/me/bind-inviter', {
            method: 'POST',
            body: JSON.stringify({ invite_code: inviteCode })
        });
        showToast(result.message, 'success');
        loadReferralInfo(); // é‡æ–°åŠ è½½
    } catch (error) {
        showToast(error.message || 'ç»‘å®šå¤±è´¥', 'error');
    }
});
</script>
{% endblock %}
