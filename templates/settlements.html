{% extends "base.html" %}

{% block title %}ç»“ç®—ç®¡ç† - å¿«æ‰‹è´¦å·ç®¡ç†å¹³å°{% endblock %}

{% block page_title %}ç»“ç®—ç®¡ç†{% endblock %}

{% block content %}
<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('periods')">ç»“ç®—å‘¨æœŸ</button>
    <button class="tab-btn" onclick="switchTab('details')">æˆ‘çš„ç»“ç®—</button>
</div>

<!-- ç»“ç®—å‘¨æœŸåˆ—è¡¨ -->
<div class="tab-content" id="periodsTab">
    <div class="data-card">
        <div class="card-header">
            <h3>ç»“ç®—å‘¨æœŸåˆ—è¡¨</h3>
            <div class="admin-only">
                <button class="btn btn-primary btn-sm" onclick="openAddPeriodModal()">â• æ–°å»ºå‘¨æœŸ</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="data-table" id="periodsTable">
                <thead>
                    <tr>
                        <th>å‘¨æœŸæ ‡è¯†</th>
                        <th>å¼€å§‹æ—¥æœŸ</th>
                        <th>ç»“æŸæ—¥æœŸ</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="periodsTableBody">
                    <tr><td colspan="5" class="loading-cell">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- æˆ‘çš„ç»“ç®—æ˜ç»† -->
<div class="tab-content" id="detailsTab" style="display: none;">
    <div class="stats-overview">
        <div class="stat-card">
            <div class="stat-icon">ğŸ’°</div>
            <div class="stat-content">
                <span class="stat-value" id="totalSettled">Â¥0.00</span>
                <span class="stat-label">å·²ç»“ç®—é‡‘é¢</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">â³</div>
            <div class="stat-content">
                <span class="stat-value" id="pendingAmount">Â¥0.00</span>
                <span class="stat-label">å¾…ç»“ç®—é‡‘é¢</span>
            </div>
        </div>
    </div>
    
    <div class="data-card">
        <div class="card-header">
            <h3>ç»“ç®—æ˜ç»†</h3>
        </div>
        <div class="table-responsive">
            <table class="data-table" id="detailsTable">
                <thead>
                    <tr>
                        <th>å‘¨æœŸ</th>
                        <th>æ€»é‡‘å¸</th>
                        <th>å…‘æ¢æ¯”ä¾‹</th>
                        <th>æ€»é‡‘é¢</th>
                        <th>æˆ‘çš„æ”¶å…¥</th>
                        <th>+1åˆ†æˆ</th>
                        <th>+2åˆ†æˆ</th>
                        <th>çŠ¶æ€</th>
                        <th>ç»“ç®—æ—¶é—´</th>
                    </tr>
                </thead>
                <tbody id="detailsTableBody">
                    <tr><td colspan="9" class="loading-cell">åŠ è½½ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- æ–°å»ºå‘¨æœŸæ¨¡æ€æ¡† -->
<div class="modal-overlay" id="periodModal" style="display: none;">
    <div class="modal">
        <div class="modal-header">
            <h3>æ–°å»ºç»“ç®—å‘¨æœŸ</h3>
            <button class="modal-close" onclick="closePeriodModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="periodForm">
                <div class="form-group">
                    <label>å‘¨æœŸæ ‡è¯† <span class="required">*</span></label>
                    <input type="text" id="periodLabel" placeholder="å¦‚ 2025W01" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å¼€å§‹æ—¥æœŸ <span class="required">*</span></label>
                        <input type="date" id="periodStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>ç»“æŸæ—¥æœŸ <span class="required">*</span></label>
                        <input type="date" id="periodEndDate" required>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closePeriodModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="savePeriod()">åˆ›å»º</button>
        </div>
    </div>
</div>

<script>
let periods = [];
let details = [];

document.addEventListener('DOMContentLoaded', function() {
    loadPeriods();
    loadDetails();
});

function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
    
    event.target.classList.add('active');
    document.getElementById(tab + 'Tab').style.display = 'block';
}

async function loadPeriods() {
    const tbody = document.getElementById('periodsTableBody');
    try {
        periods = await apiRequest('/settlement-periods');
        renderPeriods();
    } catch (error) {
        tbody.innerHTML = '<tr><td colspan="5" class="error-cell">åŠ è½½å¤±è´¥</td></tr>';
    }
}

function renderPeriods() {
    const tbody = document.getElementById('periodsTableBody');
    if (!periods || periods.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-cell">æš‚æ— ç»“ç®—å‘¨æœŸ</td></tr>';
        return;
    }
    
    tbody.innerHTML = periods.map(p => `
        <tr>
            <td><strong>${p.period_label}</strong></td>
            <td>${p.start_date}</td>
            <td>${p.end_date}</td>
            <td><span class="status-badge status-${p.status}">${p.status === 'open' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}</span></td>
            <td class="action-cell">
                <button class="btn btn-secondary btn-sm" onclick="viewPeriodDetails(${p.id})">æŸ¥çœ‹æ˜ç»†</button>
                <button class="btn-icon admin-only" onclick="closePeriod(${p.id})" title="ç»“æŸå‘¨æœŸ" ${p.status === 'closed' ? 'disabled' : ''}>ğŸ”’</button>
            </td>
        </tr>
    `).join('');
}

async function loadDetails() {
    const tbody = document.getElementById('detailsTableBody');
    try {
        details = await apiRequest('/settlement-details/my');
        renderDetails();
        calculateTotals();
    } catch (error) {
        tbody.innerHTML = '<tr><td colspan="9" class="error-cell">åŠ è½½å¤±è´¥</td></tr>';
    }
}

function renderDetails() {
    const tbody = document.getElementById('detailsTableBody');
    if (!details || details.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="empty-cell">æš‚æ— ç»“ç®—è®°å½•</td></tr>';
        return;
    }
    
    tbody.innerHTML = details.map(d => {
        const period = periods.find(p => p.id === d.period_id);
        return `
            <tr>
                <td>${period ? period.period_label : '-'}</td>
                <td>${formatNumber(d.coins_total)}</td>
                <td>Â¥${d.rate_per_10k}/ä¸‡</td>
                <td>Â¥${d.amount_total.toFixed(2)}</td>
                <td class="highlight">Â¥${d.amount_to_user.toFixed(2)}</td>
                <td>Â¥${d.amount_to_level1.toFixed(2)}</td>
                <td>Â¥${d.amount_to_level2.toFixed(2)}</td>
                <td><span class="status-badge status-${d.status}">${getSettlementStatus(d.status)}</span></td>
                <td>${d.settled_at ? new Date(d.settled_at).toLocaleDateString() : '-'}</td>
            </tr>
        `;
    }).join('');
}

function calculateTotals() {
    let settled = 0, pending = 0;
    details.forEach(d => {
        if (d.status === 'paid') {
            settled += parseFloat(d.amount_to_user);
        } else if (d.status === 'pending') {
            pending += parseFloat(d.amount_to_user);
        }
    });
    document.getElementById('totalSettled').textContent = 'Â¥' + settled.toFixed(2);
    document.getElementById('pendingAmount').textContent = 'Â¥' + pending.toFixed(2);
}

function openAddPeriodModal() {
    document.getElementById('periodForm').reset();
    document.getElementById('periodModal').style.display = 'flex';
}

function closePeriodModal() {
    document.getElementById('periodModal').style.display = 'none';
}

async function savePeriod() {
    const data = {
        period_label: document.getElementById('periodLabel').value,
        start_date: document.getElementById('periodStartDate').value,
        end_date: document.getElementById('periodEndDate').value
    };
    
    try {
        await apiRequest('/settlement-periods', { method: 'POST', body: JSON.stringify(data) });
        showToast('ç»“ç®—å‘¨æœŸåˆ›å»ºæˆåŠŸ', 'success');
        closePeriodModal();
        loadPeriods();
    } catch (error) {
        showToast('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
    }
}

async function closePeriod(id) {
    if (!confirm('ç¡®å®šè¦ç»“æŸè¿™ä¸ªç»“ç®—å‘¨æœŸå—ï¼Ÿç»“æŸåå°†æ— æ³•ä¿®æ”¹ã€‚')) return;
    
    try {
        await apiRequest(`/settlement-periods/${id}/close`, { method: 'POST' });
        showToast('å‘¨æœŸå·²ç»“æŸ', 'success');
        loadPeriods();
    } catch (error) {
        showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
    }
}

async function viewPeriodDetails(periodId) {
    // åˆ‡æ¢åˆ°æ˜ç»†æ ‡ç­¾å¹¶ç­›é€‰
    switchTab('details');
}

function getSettlementStatus(status) {
    const map = { 'pending': 'å¾…ç»“ç®—', 'paid': 'å·²æ”¯ä»˜', 'cancelled': 'å·²å–æ¶ˆ' };
    return map[status] || status;
}

function formatNumber(num) {
    if (num >= 10000) return (num / 10000).toFixed(1) + 'ä¸‡';
    return num.toString();
}
</script>
{% endblock %}
