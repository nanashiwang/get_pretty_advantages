# 更新日志

本项目遵循语义化版本号（SemVer）格式记录变更。

## v1.2.2（2026-01-05）

### 新增

- 结算管理：结算周期「设为生效」功能，管理员可设置全局生效期，所有用户统一使用该期进行计算。
- 结算管理：结算周期「删除」功能，管理员可删除已关闭且无缴费记录的错误结算期（级联删除关联数据）。
- 数据库：`settlement_periods` 表新增 `is_active` 字段，用于标记当前生效的结算期。
- 个人账户：新增「支付宝账号」设置功能，用于分账收款（之前仅支持结算中心缴费）。
- 个人账户：页面重构，采用左右分栏布局，左侧显示个人资料卡片，右侧为设置区域。

### 修复

- 仪表板：修复管理员用户钱包余额显示为 0 的问题（之前硬编码管理员余额为 0）。
- 后端：修复 SQLAlchemy 2.0 中 `hybrid_property` 导入路径变更导致的启动失败问题。

### 变更

- README：重写项目说明文档，突出快手脚本自动化、一键配置环境、收益统计等核心卖点。
- 推广关系：推广关系列表直接展示账号名称（被邀请人 / +1 / +2），不只显示用户ID，无需额外请求映射。

### 技术细节

- `is_active` 字段添加：如需手动执行数据库迁移，请运行：
  ```sql
  ALTER TABLE settlement_periods ADD COLUMN is_active INTEGER NOT NULL DEFAULT 0 COMMENT '是否为当前生效期：0=否 1=是（全局只能有一个为1）';
  ```

## v1.2.1（2026-01-04）

### 新增

- 结算中心：选择「支付宝」缴费方式时，自动展示已配置的收款二维码（位于缴费方式下方）。
- 缴费审核：结算期列表增加「应用(设为生效)」与「删除」操作，便于多周期管理。

### 修复

- 推广关系管理：修复关系列表中用户信息/+1/+2 展示为空的问题（加载顺序与查找方式优化）。
- 推广关系管理：关系列表直接展示被邀请人/+1/+2 的账号名称（避免仅显示用户ID）。
- 侧边栏：修复页面跳转后菜单滚动位置丢失的问题（自动记住并恢复滚动位置）。
- 结算分成入账：修复管理员确认缴费后，因 DATETIME 精度导致分成未入账（wallet 余额一直为 0）的问题。
- 提现：修复提交提现申请时报 `A transaction is already begun on this Session` 的事务冲突问题。

### 变更

- 导航菜单：暂时隐藏「充值中心」与「充值管理」入口（功能保留，仅下掉前端入口）。
- 文档：README 中「进群二维码」图片展示尺寸调整，避免占用过大版面。

## v1.2.0（2026-01-03）

### 新增

- 结算中心（阶段1）：结算期、关系快照、收益汇总、应缴、缴费记录与管理员审核（`/settlement-center`、`/admin/settlement-payments`）。
- 分成钱包（阶段2）：分成明细、下级缴清后资金化入账（locked）、钱包账本流水与汇总（`/wallet`）。
- 解锁/提现（阶段3）：分成解锁（locked -> available）、用户提现申请/取消、管理员提现审核/打款/驳回（`/admin/withdraw-requests`）。
- 仪表板新手引导：下载 APK、查看说明文档、进群二维码三栏并排展示。

### 变更

- 钱包统一使用 coins 口径记账与对账，展示金额按 `coin_rate` 换算。
- 管理端确认缴费：首次缴清触发分成资金化入账，并在满足条件时即时解锁。

### 安全

- 提现相关页面对用户可控字段做基础 HTML 转义，避免 XSS。

## v1.1.1

### 修复

- 修复同步青龙环境变量时，本地 `ql_env_id` 失效导致更新失败的问题：当青龙侧环境变量已被删除/重置时，原逻辑对 `PUT /open/envs` 直接更新会返回 `Env {"id":xx} not found`；现改为按 `env_name` 进行 upsert（存在则更新，不存在则创建），并回写最新 `ql_env_id`。

### 新增

- 增加日志文件持久化存储：Docker 部署默认将容器内日志目录 `/app/logs` 挂载到宿主机 `./logs`（见 `docker-compose.yml` 的 `volumes`）。
- 增加日志轮转配置：支持通过环境变量控制日志输出与按大小滚动（如 `LOG_MAX_BYTES=10485760` 表示单文件 10MB，`LOG_BACKUP_COUNT=5` 表示保留 5 份滚动文件）。
